/*
The main dining-room of the Hotel Cosmopolis is a decorous place. The lighting is artistically dim, and the genuine old tapestries on the walls seem, with their mediaeval calm, to discourage any essay in the riotous. Soft-footed waiters shimmer to and fro over thick, expensive carpets to the music of an orchestra which abstains wholly from the noisy modernity of jazz. To Archie, who during the past few days had been privileged to hear Miss Huskisson rehearsing, the place had a sort of brooding quiet, like the ocean just before the arrival of a cyclone. As Lucille had said, Miss Huskisson's voice was loud. It was a powerful organ, and there was no doubt that it would take the cloistered stillness of the Cosmopolis dining-room and stand it on one ear. Almost unconsciously, Archie found himself bracing his muscles and holding his breath as he had done in France at the approach of the zero hour, when awaiting the first roar of a barrage. He listened mechanically to the conversation of Mr. Blumenthal.

The music-publisher was talking with some vehemence on the subject of Labour. A recent printers' strike had bitten deeply into Mr. Blumenthal's soul. The working man, he considered, was rapidly landing God's Country in the soup, and he had twice upset his glass with the vehemence of his gesticulation. He was an energetic right-and-left-hand talker.

"The more you give 'em the more they want!" he complained. "There's no pleasing 'em! It isn't only in my business. There's your father, Mrs. Moffam!"

"Good God! Where?" said Archie, starting.

"I say, take your father's case. He's doing all he knows to get this new hotel of his finished, and what happens? A man gets fired for loafing on his job, and Connolly calls a strike. And the building operations are held up till the thing's settled! It isn't right!"

"It's a great shame," agreed Lucille. "I was reading about it in the paper this morning."

"That man Connolly's a tough guy. You'd think, being a personal friend of your father, he would--"

"I didn't know they were friends."

"Been friends for years. But a lot of difference that makes. Out come the men just the same. It isn't right! I was saying it wasn't right!" repeated Mr. Blumenthal to Archie, for he was a man who liked the attention of every member of his audience.

Archie did not reply. He was staring glassily across the room at two men who had just come in. One was a large, stout, square-faced man of commanding personality. The other was Mr. Daniel Brewster.

Mr. Blumenthal followed his gaze.

"Why, there is Connolly coming in now!"

"Father!" gasped Lucille.

Her eyes met Archie's. Archie took a hasty drink of ice-water.

"This," he murmured, "has torn it!"

"Archie, you must do something!"

"I know! But what?"

"What's the trouble?" enquired Mr. Blumenthal, mystified.

"Go over to their table and talk to them," said Lucille.

"Me!" Archie quivered. "No, I say, old thing, really!"

"Get them away!"

"How do you mean?"

"I know!" cried Lucille, inspired, "Father promised that you should be manager of the new hotel when it was built. Well, then, this strike affects you just as much as anybody else. You have a perfect right to talk it over with them. Go and ask them to have dinner up in our suite where you can discuss it quietly. Say that up there they won't be disturbed by the--the music."

At this moment, while Archie wavered, hesitating like a diver on the edge of a spring-board who is trying to summon up the necessary nerve to project himself into the deep, a bell-boy approached the table where the Messrs. Brewster and Connolly had seated themselves. He murmured something in Mr. Brewster's ear, and the proprietor of the Cosmopolis rose and followed him out of the room.

"Quick! Now's your chance!" said Lucille, eagerly. "Father's been called to the telephone. Hurry!"

Archie took another drink of ice-water to steady his shaking nerve-centers, pulled down his waistcoat, straightened his tie, and then, with something of the air of a Roman gladiator entering the arena, tottered across the room. Lucille turned to entertain the perplexed music-publisher.

The nearer Archie got to Mr. Aloysius Connolly the less did he like the looks of him. Even at a distance the Labour leader had had a formidable aspect. Seen close to, he looked even more uninviting. His face had the appearance of having been carved out of granite, and the eye which collided with Archie's as the latter, with an attempt at an ingratiating smile, pulled up a chair and sat down at the table was hard and frosty. Mr. Connolly gave the impression that he would be a good man to have on your side during a rough-and-tumble fight down on the water-front or in some lumber-camp, but he did not look chummy.

"Hallo-allo-allo!" said Archie.

"Who the devil," inquired Mr. Connolly, "are you?"

"My name's Archibald Moffam."

"That's not my fault."

"I'm jolly old Brewster's son-in-law."

"Glad to meet you."

"Glad to meet YOU," said Archie, handsomely.

"Well, good-bye!" said Mr. Connolly.

"Eh?"

"Run along and sell your papers. Your father-in-law and I have business to discuss."

"Yes, I know."

"Private," added Mr. Connolly.

"Oh, but I'm in on this binge, you know. I'm going to be the manager of the new hotel."

"You!"

"Absolutely!"

"Well, well!" said Mr. Connolly, noncommittally.

Archie, pleased with the smoothness with which matters had opened, bent forward winsomely.

"I say, you know! It won't do, you know! Absolutely no! Not a bit like it! No, no, far from it! Well, how about it? How do we go? What? Yes? No?"

"What on earth are you talking about?"

"Call it off, old thing!"

"Call what off?"

"This festive old strike."

"Not on your--hallo, Dan! Back again?"

Mr. Brewster, looming over the table like a thundercloud, regarded Archie with more than his customary hostility. Life was no pleasant thing for the proprietor of the Cosmopolis just now. Once a man starts building hotels, the thing becomes like dram-drinking. Any hitch, any sudden cutting-off of the daily dose, has the worst effects; and the strike which was holding up the construction of his latest effort had plunged Mr. Brewster into a restless gloom. In addition to having this strike on his hands, he had had to abandon his annual fishing-trip just when he had begun to enjoy it; and, as if all this were not enough, here was his son-in-law sitting at his table. Mr. Brewster had a feeling that this was more than man was meant to bear.

"What do you want?" he demanded.

"Hallo, old thing!" said Archie. "Come and join the party!"

"Don't call me old thing!"

"Right-o, old companion, just as you say. I say, I was just going to suggest to Mr. Connolly that we should all go up to my suite and talk this business over quietly."

"He says he's the manager of your new hotel," said Mr. Connolly. "Is that right?"

"I suppose so," said Mr. Brewster, gloomily.

"Then I'm doing you a kindness," said Mr. Connolly, "in not letting it be built."

Archie dabbed at his forehead with his handkerchief. The moments were flying, and it began to seem impossible to shift these two men. Mr. Connolly was as firmly settled in his chair as some primeval rock. As for Mr. Brewster, he, too, had seated himself, and was gazing at Archie with a weary repulsion. Mr. Brewster's glance always made Archie feel as though there were soup on his shirt-front.

And suddenly from the orchestra at the other end of the room there came a familiar sound, the prelude of "Mother's Knee."

"So you've started a cabaret, Dan?" said Mr. Connolly, in a satisfied voice. "I always told you you were behind the times here!"

Mr. Brewster jumped.

"Cabaret!"

He stared unbelievingly at the white-robed figure which had just mounted the orchestra dais, and then concentrated his gaze on Archie.

Archie would not have looked at his father-in-law at this juncture if he had had a free and untrammelled choice; but Mr. Brewster's eye drew his with something of the fascination which a snake's has for a rabbit. Mr. Brewster's eye was fiery and intimidating. A basilisk might have gone to him with advantage for a course of lessons. His gaze went right through Archie till the latter seemed to feel his back-hair curling crisply in the flames.

"Is this one of your fool-tricks?"

Even in this tense moment Archie found time almost unconsciously to admire his father-in-law's penetration and intuition. He seemed to have a sort of sixth sense. No doubt this was how great fortunes were made.

"Well, as a matter of fact--to be absolutely accurate--it was like this--"

"Say, cut it out!" said Mr. Connolly. "Can the chatter! I want to listen."

Archie was only too ready to oblige him. Conversation at the moment was the last thing he himself desired. He managed with a strong effort to disengage himself from Mr. Brewster's eye, and turned to the orchestra dais, where Miss Spectatia Huskisson was now beginning the first verse of Wilson Hymack's masterpiece.

Miss Huskisson, like so many of the female denizens of the Middle West, was tall and blonde and constructed on substantial lines. She was a girl whose appearance suggested the old homestead and fried pancakes and pop coming home to dinner after the morning's ploughing. Even her bobbed hair did not altogether destroy this impression. She looked big and strong and healthy, and her lungs were obviously good. She attacked the verse of the song with something of the vigour and breadth of treatment with which in other days she had reasoned with refractory mules. Her diction was the diction of one trained to call the cattle home in the teeth of Western hurricanes. Whether you wanted to or not, you heard every word.

The subdued clatter of knives and forks had ceased. The diners, unused to this sort of thing at the Cosmopolis, were trying to adjust their faculties to cope with the outburst. Waiters stood transfixed, frozen, in attitudes of service. In the momentary lull between verse and refrain Archie could hear the deep breathing of Mr. Brewster. Involuntarily he turned to gaze at him once more, as refugees from Pompeii may have turned to gaze upon Vesuvius; and, as he did so, he caught sight of Mr. Connolly, and paused in astonishment.

Mr. Connolly was an altered man. His whole personality had undergone a subtle change. His face still looked as though hewn from the living rock, but into his eyes had crept an expression which in another man might almost have been called sentimental. Incredible as it seemed to Archie, Mr. Connolly's eyes were dreamy. There was even in them a suggestion of unshed tears. And when with a vast culmination of sound Miss Huskisson reached the high note at the end of the refrain and, after holding it as some storming-party, spent but victorious, holds the summit of a hard-won redoubt, broke off suddenly, in the stillness which followed there proceeded from Mr. Connolly a deep sigh.

Miss Huskisson began the second verse. And Mr. Brewster, seeming to recover from some kind of a trance, leaped to his feet.

"Great Godfrey!"

"Sit down!" said Mr. Connolly, in a broken voice. "Sit down, Dan!"


"He went back to his mother on the train that very day:
He knew there was no other who could make him bright and gay:
He kissed her on the forehead and he whispered, 'I've come home!'
He told her he was never going any more to roam.
And onward through the happy years, till he grew old and grey,
He never once regretted those brave words he once did say:
It's a long way back to mother's knee--"


The last high note screeched across the room like a shell, and the applause that followed was like a shell's bursting. One could hardly have recognised the refined interior of the Cosmopolis dining-room. Fair women were waving napkins; brave men were hammering on the tables with the butt-end of knives, for all the world as if they imagined themselves to be in one of those distressing midnight-revue places. Miss Huskisson bowed, retired, returned, bowed, and retired again, the tears streaming down her ample face. Over in a corner Archie could see his brother-in-law clapping strenuously. A waiter, with a display of manly emotion that did him credit, dropped an order of new peas.

"Thirty years ago last October," said Mr. Connolly, in a shaking voice, "I--"

Mr. Brewster interrupted him violently.

"I'll fire that orchestra-leader! He goes to-morrow! I'll fire--" He turned on Archie. "What the devil do you mean by it, you--you--"

"Thirty years ago," said Mr. Connolly, wiping away a tear with his napkin, "I left me dear old home in the old country--"

"MY hotel a bear-garden!"

"Frightfully sorry and all that, old companion--"

"Thirty years ago last October! 'Twas a fine autumn evening the finest ye'd ever wish to see. Me old mother, she came to the station to see me off."

Mr. Brewster, who was not deeply interested in Mr. Connolly's old mother, continued to splutter inarticulately, like a firework trying to go off.

"'Ye'll always be a good boy, Aloysius?' she said to me," said Mr. Connolly, proceeding with, his autobiography. "And I said: 'Yes, Mother, I will!'" Mr. Connolly sighed and applied the napkin again. "'Twas a liar I was!" he observed, remorsefully. "Many's the dirty I've played since then. 'It's a long way back to Mother's knee.' 'Tis a true word!" He turned impulsively to Mr. Brewster. "Dan, there's a deal of trouble in this world without me going out of me way to make more. The strike is over! I'll send the men back tomorrow! There's me hand on it!"

Mr. Brewster, who had just managed to co-ordinate his views on the situation and was about to express them with the generous strength which was ever his custom when dealing with his son-in-law, checked himself abruptly. He stared at his old friend and business enemy, wondering if he could have heard aright. Hope began to creep back into Mr. Brewster's heart, like a shamefaced dog that has been away from home hunting for a day or two.

"You'll what!"

"I'll send the men back to-morrow! That song was sent to guide me, Dan! It was meant! Thirty years ago last October me dear old mother--"

Mr. Brewster bent forward attentively. His views on Mr. Connolly's dear old mother had changed. He wanted to hear all about her.

"'Twas that last note that girl sang brought it all back to me as if 'twas yesterday. As we waited on the platform, me old mother and I, out comes the train from the tunnel, and the engine lets off a screech the way ye'd hear it ten miles away. 'Twas thirty years ago--"

Archie stole softly from the table. He felt that his presence, if it had ever been required, was required no longer. Looking back, he could see his father-in-law patting Mr. Connolly affectionately on the shoulder.

Archie and Lucille lingered over their coffee. Mr. Blumenthal was out in the telephone-box settling the business end with Wilson Hymack. The music-publisher had been unstinted in his praise of "Mother's Knee." It was sure-fire, he said. The words, stated Mr. Blumenthal, were gooey enough to hurt, and the tune reminded him of every other song-hit he had ever heard. There was, in Mr. Blumenthal's opinion, nothing to stop this thing selling a million copies.

Archie smoked contentedly.

"Not a bad evening's work, old thing," he said. "Talk about birds with one stone!" He looked at Lucille reproachfully. "You don't seem bubbling over with joy."

"Oh, I am, precious!" Lucille sighed. "I was only thinking about Bill."

"What about Bill?"

"Well, it's rather awful to think of him tied for life to that-that steam-siren."

"Oh, we mustn't look on the jolly old dark side. Perhaps--Hallo, Bill, old top! We were just talking about you."

"Were you?" said Bill Brewster, in a dispirited voice.

"I take it that you want congratulations, what?"

"I want sympathy!"

"Sympathy?"

"Sympathy! And lots of it! She's gone!"

"Gone! Who?"

"Spectatia!"

"How do you mean, gone?"

Bill glowered at the tablecloth.

"Gone home. I've just seen her off in a cab. She's gone back to Washington Square to pack. She's catching the ten o'clock train back to Snake Bite. It was that damned song!" muttered Bill, in a stricken voice. "She says she never realised before she sang it to-night how hollow New York was. She said it suddenly came over her. She says she's going to give up her career and go back to her mother. What the deuce are you twiddling your fingers for?" he broke off, irritably.

"Sorry, old man. I was just counting."

"Counting? Counting what?"

"Birds, old thing. Only birds!" said Archie.

 */
const $ = new Env('闪购盲盒');
//Node.js用户请在jdCookie.js处填写京东ck;
const jdCookieNode = $.isNode() ? require('./jdCookie.js') : '';
let appId = '1EFRRxA' , homeDataFunPrefix = 'interact_template', collectScoreFunPrefix = 'harmony', message = ''
let lotteryResultFunPrefix = homeDataFunPrefix, browseTime = 6
const inviteCodes = [''];
const randomCount = $.isNode() ? 20 : 5;
const notify = $.isNode() ? require('./sendNotify') : '';
let merge = {}
//IOS等用户直接用NobyDa的jd cookie
let cookiesArr = [], cookie = '';
if ($.isNode()) {
  Object.keys(jdCookieNode).forEach((item) => {
    cookiesArr.push(jdCookieNode[item])
  })
  if (process.env.JD_DEBUG && process.env.JD_DEBUG === 'false') console.log = () => {};
} else {
  let cookiesData = $.getdata('CookiesJD') || "[]";
  cookiesData = jsonParse(cookiesData);
  cookiesArr = cookiesData.map(item => item.cookie);
  cookiesArr.reverse();
  cookiesArr.push(...[$.getdata('CookieJD2'), $.getdata('CookieJD')]);
  cookiesArr.reverse();
  cookiesArr = cookiesArr.filter(item => item !== "" && item !== null && item !== undefined);
}

const JD_API_HOST = `https://api.m.jd.com/client.action`;
!(async () => {
  if (!cookiesArr[0]) {
    $.msg($.name, '【提示】请先获取cookie\n直接使用NobyDa的京东签到获取', 'https://bean.m.jd.com/', {"open-url": "https://bean.m.jd.com/"});
    return;
  }
  await requireConfig();
  for (let i = 0; i < cookiesArr.length; i++) {
    cookie = cookiesArr[i];
    if (cookie) {
      $.UserName = decodeURIComponent(cookie.match(/pt_pin=(.+?);/) && cookie.match(/pt_pin=(.+?);/)[1])
      $.index = i + 1;
      $.isLogin = true;
      $.nickName = '';
      $.beans = 0
      message = ''
      await TotalBean();
      await shareCodesFormat();
      console.log(`\n******开始【京东账号${$.index}】${$.nickName || $.UserName}*********\n`);
      if (!$.isLogin) {
        $.msg($.name, `【提示】cookie已失效`, `京东账号${$.index} ${$.nickName || $.UserName}\n请重新登录获取\nhttps://bean.m.jd.com/bean/signIndex.action`, {"open-url": "https://bean.m.jd.com/bean/signIndex.action"});

        if ($.isNode()) {
          await notify.sendNotify(`${$.name}cookie已失效 - ${$.UserName}`, `京东账号${$.index} ${$.UserName}\n请重新登录获取cookie`);
        }
        continue
      }
      await interact_template_getHomeData()
      await showMsg();
    }
  }
})()
  .catch((e) => $.logErr(e))
  .finally(() => $.done())
//获取活动信息
function interact_template_getHomeData(timeout = 0) {
  return new Promise((resolve) => {
    setTimeout( ()=>{
      let url = {
        url : `${JD_API_HOST}`,
        headers : {
          'Origin' : `https://h5.m.jd.com`,
          'Cookie' : cookie,
          'Connection' : `keep-alive`,
          'Accept' : `application/json, text/plain, */*`,
          'Referer' : `https://h5.m.jd.com/babelDiy/Zeus/2WBcKYkn8viyxv7MoKKgfzmu7Dss/index.html`,
          'Host' : `api.m.jd.com`,
          'Accept-Encoding' : `gzip, deflate, br`,
          'Accept-Language' : `zh-cn`
        },
        body : `functionId=${homeDataFunPrefix}_getHomeData&body={"appId":"${appId}","taskToken":""}&client=wh5&clientVersion=1.0.0`
      }

      $.post(url, async (err, resp, data) => {
        try {
          data = JSON.parse(data);
          if (data.data.bizCode !== 0) {
            console.log(data.data.bizMsg);
            merge.jdBeans.fail++;
            merge.jdBeans.notify = `${data.data.bizMsg}`;
            return
          }
          scorePerLottery = data.data.result.userInfo.scorePerLottery||data.data.result.userInfo.lotteryMinusScore
          if (data.data.result.raiseInfo&&data.data.result.raiseInfo.levelList) scorePerLottery = data.data.result.raiseInfo.levelList[data.data.result.raiseInfo.scoreLevel];
          //console.log(scorePerLottery)
          for (let i = 0;i < data.data.result.taskVos.length;i ++) {
            console.log("\n" + data.data.result.taskVos[i].taskType + '-' + data.data.result.taskVos[i].taskName  + '-' + (data.data.result.taskVos[i].status === 1 ? `已完成${data.data.result.taskVos[i].times}-未完成${data.data.result.taskVos[i].maxTimes}` : "全部已完成"))
            //签到
            if (data.data.result.taskVos[i].taskName === '邀人助力任务') {
              console.log(`您的好友助力码为:${data.data.result.taskVos[i].assistTaskDetailVo.taskToken}`)
              for (let code of $.newShareCodes) {
                if (!code) continue
                await harmony_collectScore(code, data.data.result.taskVos[i].taskId);
                await $.wait(2000)
              }
            }
            else if (data.data.result.taskVos[i].status === 3) {
              console.log('开始抽奖')
              await interact_template_getLotteryResult(data.data.result.taskVos[i].taskId);
            }
            else if ([0,13].includes(data.data.result.taskVos[i].taskType)) {
              if (data.data.result.taskVos[i].status === 1) {
                await harmony_collectScore(data.data.result.taskVos[i].simpleRecordInfoVo.taskToken,data.data.result.taskVos[i].taskId);
              }
            }
            else if ([14,6].includes(data.data.result.taskVos[i].taskType)) {
              //console.log(data.data.result.taskVos[i].assistTaskDetailVo.taskToken)
              for (let j = 0;j <(data.data.result.userInfo.lotteryNum||0);j++) {
                if (appId === "1EFRTxQ") {
                  await ts_smashGoldenEggs()
                }  else {
                  await interact_template_getLotteryResult(data.data.result.taskVos[i].taskId);
                }
              }
            }
            let list = data.data.result.taskVos[i].productInfoVos || data.data.result.taskVos[i].followShopVo || data.data.result.taskVos[i].shoppingActivityVos || data.data.result.taskVos[i].browseShopVo
            for (let k = data.data.result.taskVos[i].times; k < data.data.result.taskVos[i].maxTimes; k++) {
              for (let j in list) {
                if (list[j].status === 1) {
                  //console.log(list[j].simpleRecordInfoVo||list[j].assistTaskDetailVo)
                  console.log("\n" + (list[j].title || list[j].shopName||list[j].skuName))
                  //console.log(list[j].itemId)
                  if (list[j].itemId) {
                    await harmony_collectScore(list[j].taskToken,data.data.result.taskVos[i].taskId,list[j].itemId,1);
                    if (k === data.data.result.taskVos[i].maxTimes - 1) await interact_template_getLotteryResult(data.data.result.taskVos[i].taskId);
                  } else {
                    await harmony_collectScore(list[j].taskToken,data.data.result.taskVos[i].taskId)
                  }
                  list[j].status = 2;
                  break;
                }
              }
            }
          }
          if (scorePerLottery) await interact_template_getLotteryResult();
        } catch (e) {
          $.logErr(e, resp);
        } finally {
          resolve()
        }
      })
    },timeout)
  })
}
//做任务
function harmony_collectScore(taskToken,taskId,itemId = "",actionType = 0,timeout = 0) {
  return new Promise((resolve) => {
    setTimeout( ()=>{
      let url = {
        url : `${JD_API_HOST}`,
        headers : {
          'Origin' : `https://h5.m.jd.com`,
          'Cookie' : cookie,
          'Connection' : `keep-alive`,
          'Accept' : `application/json, text/plain, */*`,
          'Referer' : `https://h5.m.jd.com/babelDiy/Zeus/2WBcKYkn8viyxv7MoKKgfzmu7Dss/index.html`,//?inviteId=P225KkcRx4b8lbWJU72wvZZcwCjVXmYaS5jQ P225KkcRx4b8lbWJU72wvZZcwCjVXmYaS5jQ?inviteId=${shareCode}
          'Host' : `api.m.jd.com`,
          'Accept-Encoding' : `gzip, deflate, br`,
          'Accept-Language' : `zh-cn`
        },
        body : `functionId=${collectScoreFunPrefix}_collectScore&body={"appId":"${appId}","taskToken":"${taskToken}","taskId":${taskId}${itemId ? ',"itemId":"'+itemId+'"' : ''},"actionType":${actionType}&client=wh5&clientVersion=1.0.0`
      }
      //console.log(url.body)
      //if (appId === "1EFRTxQ") url.body += "&appid=golden-egg"
      $.post(url, async (err, resp, data) => {
        try {
          data = JSON.parse(data);
          if (data.data.bizMsg === "任务领取成功") {
            await harmony_collectScore(taskToken,taskId,itemId,0,parseInt(browseTime) * 1000);
          } else{
            console.log(data.data.bizMsg)
          }
        } catch (e) {
          $.logErr(e, resp);
        } finally {
          resolve()
        }
      })
    },timeout)
  })
}
//抽奖
function interact_template_getLotteryResult(taskId,timeout = 0) {
  return new Promise((resolve) => {
    setTimeout( ()=>{
      let url = {
        url : `${JD_API_HOST}`,
        headers : {
          'Origin' : `https://h5.m.jd.com`,
          'Cookie' : cookie,
          'Connection' : `keep-alive`,
          'Accept' : `application/json, text/plain, */*`,
          'Referer' : `https://h5.m.jd.com/babelDiy/Zeus/2WBcKYkn8viyxv7MoKKgfzmu7Dss/index.html?inviteId=P04z54XCjVXmYaW5m9cZ2f433tIlGBj3JnLHD0`,//?inviteId=P225KkcRx4b8lbWJU72wvZZcwCjVXmYaS5jQ P225KkcRx4b8lbWJU72wvZZcwCjVXmYaS5jQ
          'Host' : `api.m.jd.com`,
          'Accept-Encoding' : `gzip, deflate, br`,
          'Accept-Language' : `zh-cn`
        },
        body : `functionId=${lotteryResultFunPrefix}_getLotteryResult&body={"appId":"${appId}"${taskId ? ',"taskId":"'+taskId+'"' : ''}}&client=wh5&clientVersion=1.0.0`
      }
      //console.log(url.body)
      //if (appId === "1EFRTxQ") url.body = `functionId=ts_getLottery&body={"appId":"${appId}"${taskId ? ',"taskId":"'+taskId+'"' : ''}}&client=wh5&clientVersion=1.0.0&appid=golden-egg`
      $.post(url, async (err, resp, data) => {
        try {
          if (!timeout) console.log('\n开始抽奖')
          data = JSON.parse(data);
          if (data.data.bizCode === 0) {
            if (data.data.result.userAwardsCacheDto.jBeanAwardVo) {
              console.log('京豆:' + data.data.result.userAwardsCacheDto.jBeanAwardVo.quantity)
              $.beans += parseInt(data.data.result.userAwardsCacheDto.jBeanAwardVo.quantity)
            }
            if (data.data.result.raiseInfo) scorePerLottery = parseInt(data.data.result.raiseInfo.nextLevelScore);
            if (parseInt(data.data.result.userScore) >= scorePerLottery && scorePerLottery) {
              await interact_template_getLotteryResult(1000)
            }
          }
        } catch (e) {
          $.logErr(e, resp);
        } finally {
          resolve()
        }
      })
    },timeout)
  })
}


//通知
function showMsg() {
  message += `任务已完成，本次运行获得京豆${$.beans}`
  return new Promise(resolve => {
    if ($.beans) $.msg($.name, '', `【京东账号${$.index}】${$.nickName}\n${message}`);
    $.log(`【京东账号${$.index}】${$.nickName}\n${message}`);
    resolve()
  })
}

function requireConfig() {
  return new Promise(async resolve => {
    console.log(`开始获取${$.name}配置文件\n`);
    //Node.js用户请在jdCookie.js处填写京东ck;
    let shareCodes = []
    console.log(`共${cookiesArr.length}个京东账号\n`);
    if ($.isNode() && process.env.JDSGMH_SHARECODES) {
      if (process.env.JDSGMH_SHARECODES.indexOf('\n') > -1) {
        shareCodes = process.env.JDSGMH_SHARECODES.split('\n');
      } else {
        shareCodes = process.env.JDSGMH_SHARECODES.split('&');
      }
    }
    $.shareCodesArr = [];
    if ($.isNode()) {
      Object.keys(shareCodes).forEach((item) => {
        if (shareCodes[item]) {
          $.shareCodesArr.push(shareCodes[item])
        }
      })
    }
    console.log(`您提供了${$.shareCodesArr.length}个账号的${$.name}助力码\n`);
    resolve()
  })
}

getArrRandomly = (arr) => {
  var len = arr.length;
  for (var i = len - 1; i >= 0; i--) {
    var randomIndex = Math.floor(Math.random() * (i + 1));
    var itemIndex = arr[randomIndex];
    arr[randomIndex] = arr[i];
    arr[i] = itemIndex;
  }
  return arr;
}


getRandomArr = (arr=[],num) => {
  const tmpArr = getArrRandomly(arr);
  let arrList = [];
  for (let i = 0; i < num; i++) {
    arrList.push(tmpArr[i]);
  };
  return arrList;
}


function readShareCode() {
console.log(`开始读取朱丽娜。。。`)
return new Promise(async resolve => {
  $.get({url: `https://raw.githubusercontent.com/jd1994527314/iosrule/cs/JD_TG/JC.json`, 'timeout': 10000}, (err, resp, data) => {
    try {
      if (err) {
        console.log(`${JSON.stringify(err)}`)
        console.log(`${$.name} API请求失败，请检查网路重试`)
      } else {
        if (data) {
          console.log(`随机取${randomCount}个码放到您固定的互助码后面(不影响已有固定互助)`)
          data = JSON.parse(data);
        }
      }
    } catch (e) {
      $.logErr(e, resp)
    } finally {
      resolve(data);
    }
  })
  await $.wait(10000);
  resolve()
})
}
//格式化助力码
function shareCodesFormat() {
return new Promise(async resolve => {
  // console.log(`第${$.index}个京东账号的助力码:::${$.shareCodesArr[$.index - 1]}`)
  $.newShareCodes = [];

  const readShareCodeRes = await readShareCode();
  
  if (readShareCodeRes && readShareCodeRes.code === 200) {
$.newShareCodes = [...new Set([...$.newShareCodes, ...(getRandomArr(getArrRandomly(readShareCodeRes.data),randomCount)|| [])])];
  }
  
  console.log(`第${$.index}个京东账号将要助力的好友${JSON.stringify($.newShareCodes)}`)





  resolve();
})
}

function TotalBean() {
  return new Promise(async resolve => {
    const options = {
      "url": `https://wq.jd.com/user/info/QueryJDUserInfo?sceneval=2`,
      "headers": {
        "Accept": "application/json,text/plain, */*",
        "Content-Type": "application/x-www-form-urlencoded",
        "Accept-Encoding": "gzip, deflate, br",
        "Accept-Language": "zh-cn",
        "Connection": "keep-alive",
        "Cookie": cookie,
        "Referer": "https://wqs.jd.com/my/jingdou/my.shtml?sceneval=2",
        "User-Agent": $.isNode() ? (process.env.JD_USER_AGENT ? process.env.JD_USER_AGENT : "jdapp;iPhone;9.2.2;14.2;%E4%BA%AC%E4%B8%9C/9.2.2 CFNetwork/1206 Darwin/20.1.0") : ($.getdata('JDUA') ? $.getdata('JDUA') : "jdapp;iPhone;9.2.2;14.2;%E4%BA%AC%E4%B8%9C/9.2.2 CFNetwork/1206 Darwin/20.1.0")
      }
    }
    $.post(options, (err, resp, data) => {
      try {
        if (err) {
          console.log(`${JSON.stringify(err)}`)
          console.log(`${$.name} API请求失败，请检查网路重试`)
        } else {
          if (data) {
            data = JSON.parse(data);
            if (data['retcode'] === 13) {
              $.isLogin = false; //cookie过期
              return
            }
            $.nickName = data['base'].nickname;
          } else {
            console.log(`京东服务器返回空数据`)
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve();
      }
    })
  })
}
function jsonParse(str) {
  if (typeof str == "string") {
    try {
      return JSON.parse(str);
    } catch (e) {
      console.log(e);
      $.msg($.name, '', '请勿随意在BoxJs输入框修改内容\n建议通过脚本去获取cookie')
      return [];
    }
  }
}
function Env(t,e){class s{constructor(t){this.env=t}send(t,e="GET"){t="string"==typeof t?{url:t}:t;let s=this.get;return"POST"===e&&(s=this.post),new Promise((e,i)=>{s.call(this,t,(t,s,r)=>{t?i(t):e(s)})})}get(t){return this.send.call(this.env,t)}post(t){return this.send.call(this.env,t,"POST")}}return new class{constructor(t,e){this.name=t,this.http=new s(this),this.data=null,this.dataFile="box.dat",this.logs=[],this.isMute=!1,this.isNeedRewrite=!1,this.logSeparator="\n",this.startTime=(new Date).getTime(),Object.assign(this,e),this.log("",`\ud83d\udd14${this.name}, \u5f00\u59cb!`)}isNode(){return"undefined"!=typeof module&&!!module.exports}isQuanX(){return"undefined"!=typeof $task}isSurge(){return"undefined"!=typeof $httpClient&&"undefined"==typeof $loon}isLoon(){return"undefined"!=typeof $loon}toObj(t,e=null){try{return JSON.parse(t)}catch{return e}}toStr(t,e=null){try{return JSON.stringify(t)}catch{return e}}getjson(t,e){let s=e;const i=this.getdata(t);if(i)try{s=JSON.parse(this.getdata(t))}catch{}return s}setjson(t,e){try{return this.setdata(JSON.stringify(t),e)}catch{return!1}}getScript(t){return new Promise(e=>{this.get({url:t},(t,s,i)=>e(i))})}runScript(t,e){return new Promise(s=>{let i=this.getdata("@chavy_boxjs_userCfgs.httpapi");i=i?i.replace(/\n/g,"").trim():i;let r=this.getdata("@chavy_boxjs_userCfgs.httpapi_timeout");r=r?1*r:20,r=e&&e.timeout?e.timeout:r;const[o,h]=i.split("@"),a={url:`http://${h}/v1/scripting/evaluate`,body:{script_text:t,mock_type:"cron",timeout:r},headers:{"X-Key":o,Accept:"*/*"}};this.post(a,(t,e,i)=>s(i))}).catch(t=>this.logErr(t))}loaddata(){if(!this.isNode())return{};{this.fs=this.fs?this.fs:require("fs"),this.path=this.path?this.path:require("path");const t=this.path.resolve(this.dataFile),e=this.path.resolve(process.cwd(),this.dataFile),s=this.fs.existsSync(t),i=!s&&this.fs.existsSync(e);if(!s&&!i)return{};{const i=s?t:e;try{return JSON.parse(this.fs.readFileSync(i))}catch(t){return{}}}}}writedata(){if(this.isNode()){this.fs=this.fs?this.fs:require("fs"),this.path=this.path?this.path:require("path");const t=this.path.resolve(this.dataFile),e=this.path.resolve(process.cwd(),this.dataFile),s=this.fs.existsSync(t),i=!s&&this.fs.existsSync(e),r=JSON.stringify(this.data);s?this.fs.writeFileSync(t,r):i?this.fs.writeFileSync(e,r):this.fs.writeFileSync(t,r)}}lodash_get(t,e,s){const i=e.replace(/\[(\d+)\]/g,".$1").split(".");let r=t;for(const t of i)if(r=Object(r)[t],void 0===r)return s;return r}lodash_set(t,e,s){return Object(t)!==t?t:(Array.isArray(e)||(e=e.toString().match(/[^.[\]]+/g)||[]),e.slice(0,-1).reduce((t,s,i)=>Object(t[s])===t[s]?t[s]:t[s]=Math.abs(e[i+1])>>0==+e[i+1]?[]:{},t)[e[e.length-1]]=s,t)}getdata(t){let e=this.getval(t);if(/^@/.test(t)){const[,s,i]=/^@(.*?)\.(.*?)$/.exec(t),r=s?this.getval(s):"";if(r)try{const t=JSON.parse(r);e=t?this.lodash_get(t,i,""):e}catch(t){e=""}}return e}setdata(t,e){let s=!1;if(/^@/.test(e)){const[,i,r]=/^@(.*?)\.(.*?)$/.exec(e),o=this.getval(i),h=i?"null"===o?null:o||"{}":"{}";try{const e=JSON.parse(h);this.lodash_set(e,r,t),s=this.setval(JSON.stringify(e),i)}catch(e){const o={};this.lodash_set(o,r,t),s=this.setval(JSON.stringify(o),i)}}else s=this.setval(t,e);return s}getval(t){return this.isSurge()||this.isLoon()?$persistentStore.read(t):this.isQuanX()?$prefs.valueForKey(t):this.isNode()?(this.data=this.loaddata(),this.data[t]):this.data&&this.data[t]||null}setval(t,e){return this.isSurge()||this.isLoon()?$persistentStore.write(t,e):this.isQuanX()?$prefs.setValueForKey(t,e):this.isNode()?(this.data=this.loaddata(),this.data[e]=t,this.writedata(),!0):this.data&&this.data[e]||null}initGotEnv(t){this.got=this.got?this.got:require("got"),this.cktough=this.cktough?this.cktough:require("tough-cookie"),this.ckjar=this.ckjar?this.ckjar:new this.cktough.CookieJar,t&&(t.headers=t.headers?t.headers:{},void 0===t.headers.Cookie&&void 0===t.cookieJar&&(t.cookieJar=this.ckjar))}get(t,e=(()=>{})){t.headers&&(delete t.headers["Content-Type"],delete t.headers["Content-Length"]),this.isSurge()||this.isLoon()?(this.isSurge()&&this.isNeedRewrite&&(t.headers=t.headers||{},Object.assign(t.headers,{"X-Surge-Skip-Scripting":!1})),$httpClient.get(t,(t,s,i)=>{!t&&s&&(s.body=i,s.statusCode=s.status),e(t,s,i)})):this.isQuanX()?(this.isNeedRewrite&&(t.opts=t.opts||{},Object.assign(t.opts,{hints:!1})),$task.fetch(t).then(t=>{const{statusCode:s,statusCode:i,headers:r,body:o}=t;e(null,{status:s,statusCode:i,headers:r,body:o},o)},t=>e(t))):this.isNode()&&(this.initGotEnv(t),this.got(t).on("redirect",(t,e)=>{try{if(t.headers["set-cookie"]){const s=t.headers["set-cookie"].map(this.cktough.Cookie.parse).toString();this.ckjar.setCookieSync(s,null),e.cookieJar=this.ckjar}}catch(t){this.logErr(t)}}).then(t=>{const{statusCode:s,statusCode:i,headers:r,body:o}=t;e(null,{status:s,statusCode:i,headers:r,body:o},o)},t=>{const{message:s,response:i}=t;e(s,i,i&&i.body)}))}post(t,e=(()=>{})){if(t.body&&t.headers&&!t.headers["Content-Type"]&&(t.headers["Content-Type"]="application/x-www-form-urlencoded"),t.headers&&delete t.headers["Content-Length"],this.isSurge()||this.isLoon())this.isSurge()&&this.isNeedRewrite&&(t.headers=t.headers||{},Object.assign(t.headers,{"X-Surge-Skip-Scripting":!1})),$httpClient.post(t,(t,s,i)=>{!t&&s&&(s.body=i,s.statusCode=s.status),e(t,s,i)});else if(this.isQuanX())t.method="POST",this.isNeedRewrite&&(t.opts=t.opts||{},Object.assign(t.opts,{hints:!1})),$task.fetch(t).then(t=>{const{statusCode:s,statusCode:i,headers:r,body:o}=t;e(null,{status:s,statusCode:i,headers:r,body:o},o)},t=>e(t));else if(this.isNode()){this.initGotEnv(t);const{url:s,...i}=t;this.got.post(s,i).then(t=>{const{statusCode:s,statusCode:i,headers:r,body:o}=t;e(null,{status:s,statusCode:i,headers:r,body:o},o)},t=>{const{message:s,response:i}=t;e(s,i,i&&i.body)})}}time(t){let e={"M+":(new Date).getMonth()+1,"d+":(new Date).getDate(),"H+":(new Date).getHours(),"m+":(new Date).getMinutes(),"s+":(new Date).getSeconds(),"q+":Math.floor(((new Date).getMonth()+3)/3),S:(new Date).getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,((new Date).getFullYear()+"").substr(4-RegExp.$1.length)));for(let s in e)new RegExp("("+s+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?e[s]:("00"+e[s]).substr((""+e[s]).length)));return t}msg(e=t,s="",i="",r){const o=t=>{if(!t)return t;if("string"==typeof t)return this.isLoon()?t:this.isQuanX()?{"open-url":t}:this.isSurge()?{url:t}:void 0;if("object"==typeof t){if(this.isLoon()){let e=t.openUrl||t.url||t["open-url"],s=t.mediaUrl||t["media-url"];return{openUrl:e,mediaUrl:s}}if(this.isQuanX()){let e=t["open-url"]||t.url||t.openUrl,s=t["media-url"]||t.mediaUrl;return{"open-url":e,"media-url":s}}if(this.isSurge()){let e=t.url||t.openUrl||t["open-url"];return{url:e}}}};this.isMute||(this.isSurge()||this.isLoon()?$notification.post(e,s,i,o(r)):this.isQuanX()&&$notify(e,s,i,o(r)));let h=["","==============\ud83d\udce3\u7cfb\u7edf\u901a\u77e5\ud83d\udce3=============="];h.push(e),s&&h.push(s),i&&h.push(i),console.log(h.join("\n")),this.logs=this.logs.concat(h)}log(...t){t.length>0&&(this.logs=[...this.logs,...t]),console.log(t.join(this.logSeparator))}logErr(t,e){const s=!this.isSurge()&&!this.isQuanX()&&!this.isLoon();s?this.log("",`\u2757\ufe0f${this.name}, \u9519\u8bef!`,t.stack):this.log("",`\u2757\ufe0f${this.name}, \u9519\u8bef!`,t)}wait(t){return new Promise(e=>setTimeout(e,t))}done(t={}){const e=(new Date).getTime(),s=(e-this.startTime)/1e3;this.log("",`\ud83d\udd14${this.name}, \u7ed3\u675f! \ud83d\udd5b ${s} \u79d2`),this.log(),(this.isSurge()||this.isQuanX()||this.isLoon())&&$done(t)}}(t,e)}
