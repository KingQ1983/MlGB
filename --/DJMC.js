/*
Lucille moved her wrist slowly round, the better to examine the new bracelet.

"You really are an angel, angel!" she murmured.

"Like it?" said Archie complacently.

"LIKE it! Why, it's gorgeous! It must have cost a fortune."

"Oh, nothing to speak of. Just a few hard-earned pieces of eight. Just a few doubloons from the old oak chest."

"But I didn't know there were any doubloons in the old oak chest."

"Well, as a matter of fact," admitted Archie, "at one point in the proceedings there weren't. But an aunt of mine in England--peace be on her head!--happened to send me a chunk of the necessary at what you might call the psychological moment."

"And you spent it all on a birthday present for me! Archie!" Lucille gazed at her husband adoringly. "Archie, do you know what I think?"

"What?"

"You're the perfect man!"

"No, really! What ho!"

"Yes," said Lucille firmly. "I've long suspected it, and now I know. I don't think there's anybody like you in the world."

Archie patted her hand.

"It's a rummy thing," he observed, "but your father said almost exactly that to me only yesterday. Only I don't fancy he meant the same as you. To be absolutely frank, his exact expression was that he thanked God there was only one of me."

A troubled look came into Lucille's grey eyes.

"It's a shame about father. I do wish he appreciated you. But you mustn't be too hard on him."

"Me?" said Archie. "Hard on your father? Well, dash it all, I don't think I treat him with what you might call actual brutality, what! I mean to say, my whole idea is rather to keep out of the old lad's way and curl up in a ball if I can't dodge him. I'd just as soon be hard on a stampeding elephant! I wouldn't for the world say anything derogatory, as it were, to your jolly old pater, but there is no getting away from the fact that he's by way of being one of our leading man-eating fishes. It would be idle to deny that he considers that you let down the proud old name of Brewster a bit when you brought me in and laid me on the mat."

"Anyone would be lucky to get you for a son-in-law, precious."

"I fear me, light of my life, the dad doesn't see eye to eye with you on that point. No, every time I get hold of a daisy, I give him another chance, but it always works out at 'He loves me not!'"

"You must make allowances for him, darling."

"Right-o! But I hope devoutly that he doesn't catch me at it. I've a sort of idea that if the old dad discovered that I was making allowances for him, he would have from ten to fifteen fits."

"He's worried just now, you know."

"I didn't know. He doesn't confide in me much."

"He's worried about that waiter."

"What waiter, queen of my soul?"

"A man called Salvatore. Father dismissed him some time ago."

"Salvatore!"

"Probably you don't remember him. He used to wait on this table."

"Why--"

"And father dismissed him, apparently, and now there's all sorts of trouble. You see, father wants to build this new hotel of his, and he thought he'd got the site and everything and could start building right away: and now he finds that this man Salvatore's mother owns a little newspaper and tobacco shop right in the middle of the site, and there's no way of getting him out without buying the shop, and he won't sell. At least, he's made his mother promise that she won't sell."

"A boy's best friend is his mother," said Archie approvingly. "I had a sort of idea all along--"

"So father's in despair."

Archie drew at his cigarette meditatively.

"I remember a chappie--a policeman he was, as a matter of fact, and incidentally a fairly pronounced blighter--remarking to me some time ago that you could trample on the poor man's face but you mustn't be surprised if he bit you in the leg while you were doing it. Apparently this is what has happened to the old dad. I had a sort of idea all along that old friend Salvatore would come out strong in the end if you only gave him time. Brainy sort of feller! Great pal of mine."-Lucille's small face lightened. She gazed at Archie with proud affection. She felt that she ought to have known that he was the one to solve this difficulty.

"You're wonderful, darling! Is he really a friend of yours?"

"Absolutely. Many's the time he and I have chatted in this very grill-room."

"Then it's all right. If you went to him and argued with him, he would agree to sell the shop, and father would be happy. Think how grateful father would be to you! It would make all the difference."

Archie turned this over in his mind.

"Something in that," he agreed.

"It would make him see what a pet lambkin you really are!"

"Well," said Archie, "I'm bound to say that any scheme which what you might call culminates in your father regarding me as a pet lambkin ought to receive one's best attention. How much did he offer Salvatore for his shop?"

"I don't know. There is father.--Call him over and ask him."

Archie glanced over to where Mr. Brewster had sunk moodily into a chair at a neighbouring table. It was plain even at that distance that Daniel Brewster had his troubles and was bearing them with an ill grace. He was scowling absently at the table-cloth.

"YOU call him," said Archie, having inspected his formidable relative. "You know him better."

"Let's go over to him."

They crossed the room. Lucille sat down opposite her father.-Archie draped himself over a chair in the background.

"Father, dear," said Lucille. "Archie has got an idea."

"Archie?" said Mr. Brewster incredulously.

"This is me," said Archie, indicating himself with a spoon. "The tall, distinguished-looking bird."

"What new fool-thing is he up to now?"

"It's a splendid idea, father. He wants to help you over your new hotel."

"Wants to run it for me, I suppose?"

"By Jove!" said Archie, reflectively. "That's not a bad scheme! I never thought of running an hotel. I shouldn't mind taking a stab at it."

"He has thought of a way of getting rid of Salvatore and his shop."

For the first time Mr. Brewster's interest in the conversation seemed to stir. He looked sharply at his son-in-law.

"He has, has he?" he said.

Archie balanced a roll on a fork and inserted a plate underneath. The roll bounded away into a corner.

"Sorry!" said Archie. "My fault, absolutely! I owe you a roll. I'll sign a bill for it. Oh, about this sportsman Salvatore, Well, it's like this, you know. He and I are great pals. I've known him for years and years. At least, it seems like years and years. Lu was suggesting that I seek him out in his lair and ensnare him with my diplomatic manner and superior brain power and what not."

"It was your idea, precious," said Lucille.

Mr. Brewster was silent.--Much as it went against the grain to have to admit it, there seemed to be something in this.

"What do you propose to do?"

"Become a jolly old ambassador. How much did you offer the chappie?"

"Three thousand dollars. Twice as much as the place is worth. He's holding out on me for revenge."

"Ah, but how did you offer it to him, what? I mean to say, I bet you got your lawyer to write him a letter full of whereases, peradventures, and parties of the first part, and so forth. No good, old companion!"

"Don't call me old companion!"

"All wrong, laddie! Nothing like it, dear heart! No good at all, friend of my youth! Take it from your Uncle Archibald! I'm a student of human nature, and I know a thing or two."

"That's not much," growled Mr. Brewster, who was finding his son-in-law's superior manner a little trying.

"Now, don't interrupt, father," said Lucille, severely. "Can't you see that Archie is going to be tremendously clever in a minute?"

"He's got to show me!"

"What you ought to do," said Archie, "is to let me go and see him, taking the stuff in crackling bills. I'll roll them about on the table in front of him. That'll fetch him!" He prodded Mr. Brewster encouragingly with a roll. "I'll tell you what to do. Give me three thousand of the best and crispest, and I'll undertake to buy that shop. It can't fail, laddie!"

"Don't call me laddie!" Mr. Brewster pondered. "Very well," he said at last. "I didn't know you had so much sense," he added grudgingly.

"Oh, positively!" said Archie. "Beneath a rugged exterior I hide a brain like a buzz-saw. Sense? I exude it, laddie; I drip with it."

There were moments during the ensuing days when Mr. Brewster permitted himself to hope; but more frequent were the moments when he told himself that a pronounced chump like his son-in-law could not fail somehow to make a mess of the negotiations. His relief, therefore, when Archie curveted into his private room and announced that he had succeeded was great.

"You really managed to make that wop sell out?"

Archie brushed some papers off the desk with a careless gesture, and seated himself on the vacant spot.

"Absolutely! I spoke to him as one old friend to another, sprayed the bills all over the place; and he sang a few bars from 'Rigoletto,' and signed on the dotted line."

"You're not such a fool as you look," owned Mr. Brewster.

Archie scratched a match on the desk and lit a cigarette.

"It's a jolly little shop," he said. "I took quite a fancy to it. Full of newspapers, don't you know, and cheap novels, and some weird-looking sort of chocolates, and cigars with the most fearfully attractive labels. I think I'll make a success of it. It's bang in the middle of a dashed good neighbourhood. One of these days somebody will be building a big hotel round about there, and that'll help trade a lot. I look forward to ending my days on the other side of the counter with a full set of white whiskers and a skull-cap, beloved by everybody. Everybody'll say, 'Oh, you MUST patronise that quaint, delightful old blighter! He's quite a character.'"

Mr. Brewster's air of grim satisfaction had given way to a look of discomfort, almost of alarm. He presumed his son-in-law was merely indulging in badinage; but even so, his words were not soothing.

"Well, I'm much obliged," he said. "That infernal shop was holding up everything. Now I can start building right away."

Archie raised his eyebrows.

"But, my dear old top, I'm sorry to spoil your daydreams and stop you chasing rainbows, and all that, but aren't you forgetting that the shop belongs to me? I don't at all know that I want to sell, either!"

"I gave you the money to buy that shop!"

"And dashed generous of you it was, too!" admitted Archie, unreservedly. "It was the first money you ever gave me, and I shall always, tell interviewers that it was you who founded my fortunes. Some day, when I'm the Newspaper-and-Tobacco-Shop King, I'll tell the world all about it in my autobiography."

Mr. Brewster rose dangerously from his seat.

"Do you think you can hold me up, you--you worm?"

"Well," said Archie, "the way I look at it is this. Ever since we met, you've been after me to become one of the world's workers, and earn a living for myself, and what not; and now I see a way to repay you for your confidence and encouragement. You'll look me up sometimes at the good old shop, won't you?" He slid off the table and moved towards the door. "There won't be any formalities where you are concerned. You can sign bills for any reasonable amount any time you want a cigar or a stick of chocolate. Well, toodle-oo!"

"Stop!"

"Now what?"

"How much do you want for that damned shop?"

"I don't want money.-I want a job.-If you are going to take my life-work away from me, you ought to give me something else to do."

"What job?"

"You suggested it yourself the other day. I want to manage your new hotel."

"Don't be a fool! What do you know about managing an hotel?"

"Nothing. It will be your pleasing task to teach me the business while the shanty is being run up."

There was a pause, while Mr. Brewster chewed three inches off a pen-holder.

"Very well," he said at last.

"Topping!" said Archie. "I knew you'd, see it. I'll study your methods, what! Adding some of my own, of course. You know, I've thought of one improvement on the Cosmopolis already."

"Improvement on the Cosmopolis!" cried Mr. Brewster, gashed in his finest feelings.

"Yes. There's one point where the old Cosmop slips up badly, and I'm going to see that it's corrected at my little shack. Customers will be entreated to leave their boots outside their doors at night, and they'll find them cleaned in the morning. Well, pip, pip! I must be popping. Time is money, you know, with us business men."

*/
const $ = new Env('ä¸œä¸œèŒå® ');
let cookiesArr = [], cookie = '', jdPetShareArr = [], isBox = false, notify, newShareCodes;
//åŠ©åŠ›å¥½å‹åˆ†äº«ç (æœ€å¤š5ä¸ª,å¦åˆ™åé¢çš„åŠ©åŠ›å¤±è´¥),åŸå› :äº¬ä¸œå†œåœºæ¯äººæ¯å¤©åªæœ‰å››æ¬¡åŠ©åŠ›æœºä¼š
//æ­¤æ­¤å†…å®¹æ˜¯IOSç”¨æˆ·ä¸‹è½½è„šæœ¬åˆ°æœ¬åœ°ä½¿ç”¨ï¼Œå¡«å†™äº’åŠ©ç çš„åœ°æ–¹ï¼ŒåŒä¸€äº¬ä¸œè´¦å·çš„å¥½å‹äº’åŠ©ç è¯·ä½¿ç”¨@ç¬¦å·éš”å¼€ã€‚
//ä¸‹é¢ç»™å‡ºä¸¤ä¸ªè´¦å·çš„å¡«å†™ç¤ºä¾‹ï¼ˆiOSåªæ”¯æŒ2ä¸ªäº¬ä¸œè´¦å·ï¼‰
let shareCodes = []
let message = '', subTitle = '', option = {};
let jdNotify = false;//æ˜¯å¦å…³é—­é€šçŸ¥ï¼Œfalseæ‰“å¼€é€šçŸ¥æ¨é€ï¼Œtrueå…³é—­é€šçŸ¥æ¨é€
const JD_API_HOST = 'https://api.m.jd.com/client.action';
let goodsUrl = '', taskInfoKey = [];
let randomCount = $.isNode() ? 20 : 5;
!(async () => {
  await requireConfig();
  if (!cookiesArr[0]) {
    $.msg($.name, 'ã€æç¤ºã€‘è¯·å…ˆè·å–äº¬ä¸œè´¦å·ä¸€cookie\nç›´æ¥ä½¿ç”¨NobyDaçš„äº¬ä¸œç­¾åˆ°è·å–', 'https://bean.m.jd.com/bean/signIndex.action', {"open-url": "https://bean.m.jd.com/bean/signIndex.action"});
    return;
  }
  for (let i = 0; i < cookiesArr.length; i++) {
    if (cookiesArr[i]) {
      cookie = cookiesArr[i];
      $.UserName = decodeURIComponent(cookie.match(/pt_pin=(.+?);/) && cookie.match(/pt_pin=(.+?);/)[1])
      $.index = i + 1;
      $.isLogin = true;
      $.nickName = '';
      await TotalBean();
      console.log(`\nå¼€å§‹ã€äº¬ä¸œè´¦å·${$.index}ã€‘${$.nickName || $.UserName}\n`);
      if (!$.isLogin) {
        $.msg($.name, `ã€æç¤ºã€‘cookieå·²å¤±æ•ˆ`, `äº¬ä¸œè´¦å·${$.index} ${$.nickName || $.UserName}\nè¯·é‡æ–°ç™»å½•è·å–\nhttps://bean.m.jd.com/bean/signIndex.action`, {"open-url": "https://bean.m.jd.com/bean/signIndex.action"});

        if ($.isNode()) {
          await notify.sendNotify(`${$.name}cookieå·²å¤±æ•ˆ - ${$.UserName}`, `äº¬ä¸œè´¦å·${$.index} ${$.UserName}\nè¯·é‡æ–°ç™»å½•è·å–cookie`);
        }
        continue
      }
      message = '';
      subTitle = '';
      goodsUrl = '';
      taskInfoKey = [];
      option = {};
      await shareCodesFormat();
      await jdPet();
    }
  }
})()
    .catch((e) => {
      $.log('', `âŒ ${$.name}, å¤±è´¥! åŸå› : ${e}!`, '')
    })
    .finally(() => {
      $.done();
    })
async function jdPet() {
  try {
    //æŸ¥è¯¢jdå® ç‰©ä¿¡æ¯
    const initPetTownRes = await request('initPetTown');
    message = `ã€äº¬ä¸œè´¦å·${$.index}ã€‘${$.nickName}\n`;
    if (initPetTownRes.code === '0' && initPetTownRes.resultCode === '0' && initPetTownRes.message === 'success') {
      $.petInfo = initPetTownRes.result;
      if ($.petInfo.userStatus === 0) {
        // $.msg($.name, '', `ã€æç¤ºã€‘äº¬ä¸œè´¦å·${$.index}${$.nickName}\nèŒå® æ´»åŠ¨æœªå¼€å¯\nè¯·æ‰‹åŠ¨å»äº¬ä¸œAPPå¼€å¯æ´»åŠ¨\nå…¥å£ï¼šæˆ‘çš„->æ¸¸æˆä¸äº’åŠ¨->æŸ¥çœ‹æ›´å¤šå¼€å¯`, { "open-url": "openapp.jdmoble://" });
        await slaveHelp();//åŠ©åŠ›å¥½å‹
        $.log($.name, '', `ã€æç¤ºã€‘äº¬ä¸œè´¦å·${$.index}${$.nickName}\nèŒå® æ´»åŠ¨æœªå¼€å¯\nè¯·æ‰‹åŠ¨å»äº¬ä¸œAPPå¼€å¯æ´»åŠ¨\nå…¥å£ï¼šæˆ‘çš„->æ¸¸æˆä¸äº’åŠ¨->æŸ¥çœ‹æ›´å¤šå¼€å¯`);
        return
      }
      if (!$.petInfo.goodsInfo) {
        $.msg($.name, '', `ã€æç¤ºã€‘äº¬ä¸œè´¦å·${$.index}${$.nickName}\næš‚æœªé€‰è´­æ–°çš„å•†å“`, { "open-url": "openapp.jdmoble://" });
        if ($.isNode()) await notify.sendNotify(`${$.name} - ${$.index} - ${$.nickName}`, `ã€æç¤ºã€‘äº¬ä¸œè´¦å·${$.index}${$.nickName}\næš‚æœªé€‰è´­æ–°çš„å•†å“`);
        return
      }
      goodsUrl = $.petInfo.goodsInfo && $.petInfo.goodsInfo.goodsUrl;
      // option['media-url'] = goodsUrl;
      // console.log(`åˆå§‹åŒ–èŒå® ä¿¡æ¯å®Œæˆ: ${JSON.stringify(petInfo)}`);
      if ($.petInfo.petStatus === 5) {
        await slaveHelp();//å¯ä»¥å…‘æ¢è€Œæ²¡æœ‰å»å…‘æ¢,ä¹Ÿèƒ½ç»§ç»­åŠ©åŠ›å¥½å‹
        option['open-url'] = "openApp.jdMobile://";
        $.msg($.name, `ã€æé†’â°ã€‘${$.petInfo.goodsInfo.goodsName}å·²å¯é¢†å–`, 'è¯·å»äº¬ä¸œAPPæˆ–å¾®ä¿¡å°ç¨‹åºæŸ¥çœ‹', option);
        if ($.isNode()) {
          await notify.sendNotify(`${$.name} - è´¦å·${$.index} - ${$.nickName || $.UserName}å¥–å“å·²å¯é¢†å–`, `äº¬ä¸œè´¦å·${$.index} ${$.nickName}\n${$.petInfo.goodsInfo.goodsName}å·²å¯é¢†å–`);
        }
        return
      } else if ($.petInfo.petStatus === 6) {
        await slaveHelp();//å·²é¢†å–çº¢åŒ…,ä½†æœªé¢†å…»æ–°çš„,ä¹Ÿèƒ½ç»§ç»­åŠ©åŠ›å¥½å‹
        option['open-url'] = "openApp.jdMobile://";
        $.msg($.name, `ã€æé†’â°ã€‘å·²é¢†å–çº¢åŒ…,ä½†æœªç»§ç»­é¢†å…»æ–°çš„ç‰©å“`, 'è¯·å»äº¬ä¸œAPPæˆ–å¾®ä¿¡å°ç¨‹åºç»§ç»­é¢†å…»', option);
        if ($.isNode()) {
          await notify.sendNotify(`${$.name} - è´¦å·${$.index} - ${$.nickName || $.UserName}å¥–å“å·²å¯é¢†å–`, `äº¬ä¸œè´¦å·${$.index} ${$.nickName}\nå·²é¢†å–çº¢åŒ…,ä½†æœªç»§ç»­é¢†å…»æ–°çš„ç‰©å“`);
        }
        return
      }
      console.log(`\nã€äº¬ä¸œè´¦å·${$.index}ï¼ˆ${$.nickName || $.UserName}ï¼‰çš„${$.name}å¥½å‹äº’åŠ©ç ã€‘${$.petInfo.shareCode}\n`);
      await taskInit();
      if ($.taskInit.resultCode === '9999' || !$.taskInit.result) {
        console.log('åˆå§‹åŒ–ä»»åŠ¡å¼‚å¸¸, è¯·ç¨åå†è¯•');
        return
      }
      $.taskInfo = $.taskInit.result;

      await petSport();//é›å¼¯
      await slaveHelp();//åŠ©åŠ›å¥½å‹
      await masterHelpInit();//è·å–åŠ©åŠ›çš„ä¿¡æ¯
      await doTask();//åšæ—¥å¸¸ä»»åŠ¡
      await feedPetsAgain();//å†æ¬¡æŠ•é£Ÿ
      await energyCollect();//æ”¶é›†å¥½æ„Ÿåº¦
      await showMsg();
      console.log('å…¨éƒ¨ä»»åŠ¡å®Œæˆ, å¦‚æœå¸®åŠ©åˆ°æ‚¨å¯ä»¥ç‚¹ä¸‹ğŸŒŸSTARé¼“åŠ±æˆ‘ä¸€ä¸‹, æ˜å¤©è§~');
    } else if (initPetTownRes.code === '0'){
      console.log(`åˆå§‹åŒ–èŒå® å¤±è´¥:  ${initPetTownRes.message}`);
    }
  } catch (e) {
    $.logErr(e)
  }
}
// æ”¶å–æ‰€æœ‰å¥½æ„Ÿåº¦
async function energyCollect() {
  console.log('å¼€å§‹æ”¶å–ä»»åŠ¡å¥–åŠ±å¥½æ„Ÿåº¦');
  let function_id = arguments.callee.name.toString();
  const response = await request(function_id);
  // console.log(`æ”¶å–ä»»åŠ¡å¥–åŠ±å¥½æ„Ÿåº¦å®Œæˆ:${JSON.stringify(response)}`);
  if (response.resultCode === '0') {
    message += `ã€ç¬¬${response.result.medalNum + 1}å—å‹‹ç« å®Œæˆè¿›åº¦ã€‘${response.result.medalPercent}%ï¼Œè¿˜éœ€æ”¶é›†${response.result.needCollectEnergy}å¥½æ„Ÿ\n`;
    message += `ã€å·²è·å¾—å‹‹ç« ã€‘${response.result.medalNum}å—ï¼Œè¿˜éœ€æ”¶é›†${response.result.needCollectMedalNum}å—å³å¯å…‘æ¢å¥–å“â€œ${$.petInfo.goodsInfo.goodsName}â€\n`;
  }
}
//å†æ¬¡æŠ•é£Ÿ
async function feedPetsAgain() {
  const response = await request('initPetTown');//å†æ¬¡åˆå§‹åŒ–èŒå® 
  if (response.code === '0' && response.resultCode === '0' && response.message === 'success') {
    $.petInfo = response.result;
    let foodAmount = $.petInfo.foodAmount; //å‰©ä½™ç‹—ç²®
    if (foodAmount - 100 >= 10) {
      for (let i = 0; i < parseInt((foodAmount - 100) / 10); i++) {
        const feedPetRes = await request('feedPets');
        console.log(`æŠ•é£ŸfeedPetRes`);
        if (feedPetRes.resultCode == 0 && feedPetRes.code == 0) {
          console.log('æŠ•é£ŸæˆåŠŸ')
        }
      }
      const response2 = await request('initPetTown');
      $.petInfo = response2.result;
      subTitle = $.petInfo.goodsInfo.goodsName;
      // message += `ã€ä¸çˆ±å® ç›¸è¯†ã€‘${$.petInfo.meetDays}å¤©\n`;
      // message += `ã€å‰©ä½™ç‹—ç²®ã€‘${$.petInfo.foodAmount}g\n`;
    } else {
      console.log("ç›®å‰å‰©ä½™ç‹—ç²®ï¼šã€" + foodAmount + "ã€‘g,ä¸å†ç»§ç»­æŠ•é£Ÿ,ä¿ç•™éƒ¨åˆ†ç‹—ç²®ç”¨äºå®Œæˆç¬¬äºŒå¤©ä»»åŠ¡");
      subTitle = $.petInfo.goodsInfo && $.petInfo.goodsInfo.goodsName;
      // message += `ã€ä¸çˆ±å® ç›¸è¯†ã€‘${$.petInfo.meetDays}å¤©\n`;
      // message += `ã€å‰©ä½™ç‹—ç²®ã€‘${$.petInfo.foodAmount}g\n`;
    }
  } else {
    console.log(`åˆå§‹åŒ–èŒå® å¤±è´¥:  ${JSON.stringify($.petInfo)}`);
  }
}


async function doTask() {
  const { signInit, threeMealInit, firstFeedInit, feedReachInit, inviteFriendsInit, browseShopsInit, taskList } = $.taskInfo;
  for (let item of taskList) {
    if ($.taskInfo[item].finished) {
      console.log(`ä»»åŠ¡ ${item} å·²å®Œæˆ`)
    }
  }
  //æ¯æ—¥ç­¾åˆ°
  if (signInit && !signInit.finished) {
    await signInitFun();
  }
  // é¦–æ¬¡å–‚é£Ÿ
  if (firstFeedInit && !firstFeedInit.finished) {
    await firstFeedInitFun();
  }
  // ä¸‰é¤
  if (threeMealInit && !threeMealInit.finished) {
    if (threeMealInit.timeRange === -1) {
      console.log(`æœªåˆ°ä¸‰é¤æ—¶é—´`);
    } else {
      await threeMealInitFun();
    }
  }
  if (browseShopsInit && !browseShopsInit.finished) {
    await browseShopsInitFun();
  }
  let browseSingleShopInitList = [];
  taskList.map((item) => {
    if (item.indexOf('browseSingleShopInit') > -1) {
      browseSingleShopInitList.push(item);
    }
  });
  // å»é€›é€›å¥½è´§ä¼šåœº
  for (let item of browseSingleShopInitList) {
    const browseSingleShopInitTask = $.taskInfo[item];
    if (browseSingleShopInitTask && !browseSingleShopInitTask.finished) {
      await browseSingleShopInit(browseSingleShopInitTask);
    }
  }
  if (inviteFriendsInit && !inviteFriendsInit.finished) {
    await inviteFriendsInitFun();
  }
  // æŠ•é£Ÿ10æ¬¡
  if (feedReachInit && !feedReachInit.finished) {
    await feedReachInitFun();
  }
}
// å¥½å‹åŠ©åŠ›ä¿¡æ¯
async function masterHelpInit() {
  let res = await request(arguments.callee.name.toString());
  // console.log(`åŠ©åŠ›ä¿¡æ¯: ${JSON.stringify(res)}`);
  if (res.code === '0' && res.resultCode === '0') {
    if (res.result.masterHelpPeoples && res.result.masterHelpPeoples.length >= 5) {
      if(!res.result.addedBonusFlag) {
        console.log("å¼€å§‹é¢†å–é¢å¤–å¥–åŠ±");
        let getHelpAddedBonusResult = await request('getHelpAddedBonus');
        if (getHelpAddedBonusResult.resultCode === '0') {
          message += `ã€é¢å¤–å¥–åŠ±${getHelpAddedBonusResult.result.reward}é¢†å–ã€‘${getHelpAddedBonusResult.message}\n`;
        }
        console.log(`é¢†å–30gé¢å¤–å¥–åŠ±ç»“æœï¼šã€${getHelpAddedBonusResult.message}ã€‘`);
      } else {
        console.log("å·²ç»é¢†å–è¿‡5å¥½å‹åŠ©åŠ›é¢å¤–å¥–åŠ±");
        message += `ã€é¢å¤–å¥–åŠ±ã€‘å·²é¢†å–\n`;
      }
    } else {
      console.log("åŠ©åŠ›å¥½å‹æœªè¾¾åˆ°5ä¸ª")
      message += `ã€é¢å¤–å¥–åŠ±ã€‘é¢†å–å¤±è´¥ï¼ŒåŸå› ï¼šç»™æ‚¨åŠ©åŠ›çš„äººæœªè¾¾5ä¸ª\n`;
    }
    if (res.result.masterHelpPeoples && res.result.masterHelpPeoples.length > 0) {
      console.log('å¸®æ‚¨åŠ©åŠ›çš„å¥½å‹çš„åå•å¼€å§‹')
      let str = '';
      res.result.masterHelpPeoples.map((item, index) => {
        if (index === (res.result.masterHelpPeoples.length - 1)) {
          str += item.nickName || "åŒ¿åç”¨æˆ·";
        } else {
          str += (item.nickName || "åŒ¿åç”¨æˆ·") + 'ï¼Œ';
        }
      })
      message += `ã€åŠ©åŠ›æ‚¨çš„å¥½å‹ã€‘${str}\n`;
    }
  }
}
/**
 * åŠ©åŠ›å¥½å‹, æš‚æ—¶æ”¯æŒä¸€ä¸ªå¥½å‹, éœ€è¦æ‹¿åˆ°shareCode
 * shareCodeä¸ºä½ è¦åŠ©åŠ›çš„å¥½å‹çš„
 * è¿è¡Œè„šæœ¬æ—¶ä½ è‡ªå·±çš„shareCodeä¼šåœ¨æ§åˆ¶å°è¾“å‡º, å¯ä»¥å°†å…¶åˆ†äº«ç»™ä»–äºº
 */
async function slaveHelp() {
  //$.log(`\nå› 1.6æ—¥å¥½å‹åŠ©åŠ›åŠŸèƒ½ä¸‹çº¿ã€‚æ•…æš‚æ—¶å±è”½\n`)
  //return
  let helpPeoples = '';
  for (let code of $.newShareCodes) {
    console.log(`å¼€å§‹åŠ©åŠ›äº¬ä¸œè´¦å·${$.index} - ${$.nickName}çš„å¥½å‹: ${code}`);
    if (!code) continue;
    let response = await request(arguments.callee.name.toString(), {'shareCode': code});
    if (response.code === '0' && response.resultCode === '0') {
      if (response.result.helpStatus === 0) {
        console.log('å·²ç»™å¥½å‹: ã€' + response.result.masterNickName + 'ã€‘åŠ©åŠ›æˆåŠŸ');
        helpPeoples += response.result.masterNickName + 'ï¼Œ';
      } else if (response.result.helpStatus === 1) {
        // æ‚¨ä»Šæ—¥å·²æ— åŠ©åŠ›æœºä¼š
        console.log(`åŠ©åŠ›å¥½å‹${response.result.masterNickName}å¤±è´¥ï¼Œæ‚¨ä»Šæ—¥å·²æ— åŠ©åŠ›æœºä¼š`);
        break;
      } else if (response.result.helpStatus === 2) {
        //è¯¥å¥½å‹å·²æ»¡5äººåŠ©åŠ›ï¼Œæ— éœ€æ‚¨å†æ¬¡åŠ©åŠ›
        console.log(`è¯¥å¥½å‹${response.result.masterNickName}å·²æ»¡5äººåŠ©åŠ›ï¼Œæ— éœ€æ‚¨å†æ¬¡åŠ©åŠ›`);
      } else {
        console.log(`åŠ©åŠ›å…¶ä»–æƒ…å†µï¼š${JSON.stringify(response)}`);
      }
    } else {
      console.log(`åŠ©åŠ›å¥½å‹ç»“æœ: ${response.message}`);
    }
  }
  if (helpPeoples && helpPeoples.length > 0) {
    message += `ã€æ‚¨åŠ©åŠ›çš„å¥½å‹ã€‘${helpPeoples.substr(0, helpPeoples.length - 1)}\n`;
  }
}
// é›ç‹—, æ¯å¤©æ¬¡æ•°ä¸Šé™10æ¬¡, éšæœºç»™ç‹—ç²®, æ¯æ¬¡é›ç‹—ç»“æŸéœ€è°ƒç”¨getSportRewardé¢†å–å¥–åŠ±, æ‰èƒ½è¿›è¡Œä¸‹ä¸€æ¬¡é›ç‹—
async function petSport() {
  console.log('å¼€å§‹é›å¼¯');
  let times = 1
  const code = 0
  let resultCode = 0
  do {
    let response = await request(arguments.callee.name.toString())
    console.log(`ç¬¬${times}æ¬¡é›ç‹—å®Œæˆ: ${JSON.stringify(response)}`);
    resultCode = response.resultCode;
    if (resultCode == 0) {
      let sportRevardResult = await request('getSportReward');
      console.log(`é¢†å–é›ç‹—å¥–åŠ±å®Œæˆ: ${JSON.stringify(sportRevardResult)}`);
    }
    times++;
  } while (resultCode == 0 && code == 0)
  if (times > 1) {
    // message += 'ã€åæ¬¡é›ç‹—ã€‘å·²å®Œæˆ\n';
  }
}
// åˆå§‹åŒ–ä»»åŠ¡, å¯æŸ¥è¯¢ä»»åŠ¡å®Œæˆæƒ…å†µ
async function taskInit() {
  console.log('å¼€å§‹ä»»åŠ¡åˆå§‹åŒ–');
  $.taskInit = await request(arguments.callee.name.toString(), {"version":1});
}
// æ¯æ—¥ç­¾åˆ°, æ¯å¤©ä¸€æ¬¡
async function signInitFun() {
  console.log('å‡†å¤‡æ¯æ—¥ç­¾åˆ°');
  const response = await request("getSignReward");
  console.log(`æ¯æ—¥ç­¾åˆ°ç»“æœ: ${JSON.stringify(response)}`);
  if (response.code === '0' && response.resultCode === '0') {
    console.log(`ã€æ¯æ—¥ç­¾åˆ°æˆåŠŸã€‘å¥–åŠ±${response.result.signReward}gç‹—ç²®\n`);
    // message += `ã€æ¯æ—¥ç­¾åˆ°æˆåŠŸã€‘å¥–åŠ±${response.result.signReward}gç‹—ç²®\n`;
  } else {
    console.log(`ã€æ¯æ—¥ç­¾åˆ°ã€‘${response.message}\n`);
    // message += `ã€æ¯æ—¥ç­¾åˆ°ã€‘${response.message}\n`;
  }
}

// ä¸‰é¤ç­¾åˆ°, æ¯å¤©ä¸‰æ®µç­¾åˆ°æ—¶é—´
async function threeMealInitFun() {
  console.log('å‡†å¤‡ä¸‰é¤ç­¾åˆ°');
  const response = await request("getThreeMealReward");
  console.log(`ä¸‰é¤ç­¾åˆ°ç»“æœ: ${JSON.stringify(response)}`);
  if (response.code === '0' && response.resultCode === '0') {
    console.log(`ã€å®šæ—¶é¢†ç‹—ç²®ã€‘è·å¾—${response.result.threeMealReward}g\n`);
    // message += `ã€å®šæ—¶é¢†ç‹—ç²®ã€‘è·å¾—${response.result.threeMealReward}g\n`;
  } else {
    console.log(`ã€å®šæ—¶é¢†ç‹—ç²®ã€‘${response.message}\n`);
    // message += `ã€å®šæ—¶é¢†ç‹—ç²®ã€‘${response.message}\n`;
  }
}

// æµè§ˆæŒ‡å®šåº—é“º ä»»åŠ¡
async function browseSingleShopInit(item) {
  console.log(`å¼€å§‹åš ${item.title} ä»»åŠ¡ï¼Œ ${item.desc}`);
  const body = {"index": item['index'], "version":1, "type":1};
  const body2 = {"index": item['index'], "version":1, "type":2};
  const response = await request("getSingleShopReward", body);
  // console.log(`ç‚¹å‡»è¿›å»response::${JSON.stringify(response)}`);
  if (response.code === '0' && response.resultCode === '0') {
    const response2 = await request("getSingleShopReward", body2);
    // console.log(`æµè§ˆå®Œæ¯•é¢†å–å¥–åŠ±:response2::${JSON.stringify(response2)}`);
    if (response2.code === '0' && response2.resultCode === '0') {
      console.log(`ã€æµè§ˆæŒ‡å®šåº—é“ºã€‘è·å–${response2.result.reward}g\n`);
      // message += `ã€æµè§ˆæŒ‡å®šåº—é“ºã€‘è·å–${response2.result.reward}g\n`;
    }
  }
}

// æµè§ˆåº—é“ºä»»åŠ¡, ä»»åŠ¡å¯èƒ½ä¸ºå¤šä¸ª? ç›®å‰åªæœ‰ä¸€ä¸ª
async function browseShopsInitFun() {
  console.log('å¼€å§‹æµè§ˆåº—é“ºä»»åŠ¡');
  let times = 0;
  let resultCode = 0;
  let code = 0;
  do {
    let response = await request("getBrowseShopsReward");
    console.log(`ç¬¬${times}æ¬¡æµè§ˆåº—é“ºç»“æœ: ${JSON.stringify(response)}`);
    code = response.code;
    resultCode = response.resultCode;
    times++;
  } while (resultCode == 0 && code == 0 && times < 5)
  console.log('æµè§ˆåº—é“ºä»»åŠ¡ç»“æŸ');
}
// é¦–æ¬¡æŠ•é£Ÿ ä»»åŠ¡
function firstFeedInitFun() {
  console.log('é¦–æ¬¡æŠ•é£Ÿä»»åŠ¡åˆå¹¶åˆ°10æ¬¡å–‚é£Ÿä»»åŠ¡ä¸­\n');
}

// é‚€è¯·æ–°ç”¨æˆ·
async function inviteFriendsInitFun() {
  console.log('é‚€è¯·æ–°ç”¨æˆ·åŠŸèƒ½æœªå®ç°');
  if ($.taskInfo.inviteFriendsInit.status == 1 && $.taskInfo.inviteFriendsInit.inviteFriendsNum > 0) {
    // å¦‚æœæœ‰é‚€è¯·è¿‡æ–°ç”¨æˆ·,è‡ªåŠ¨é¢†å–60ggå¥–åŠ±
    const res = await request('getInviteFriendsReward');
    if (res.code == 0 && res.resultCode == 0) {
      console.log(`é¢†å–é‚€è¯·æ–°ç”¨æˆ·å¥–åŠ±æˆåŠŸ,è·å¾—ç‹—ç²®ç°æœ‰ç‹—ç²®${$.taskInfo.inviteFriendsInit.reward}gï¼Œ${res.result.foodAmount}g`);
      message += `ã€é‚€è¯·æ–°ç”¨æˆ·ã€‘è·å–ç‹—ç²®${$.taskInfo.inviteFriendsInit.reward}g\n`;
    }
  }
}

/**
 * æŠ•é£Ÿ10æ¬¡ ä»»åŠ¡
 */
async function feedReachInitFun() {
  console.log('æŠ•é£Ÿä»»åŠ¡å¼€å§‹...');
  let finishedTimes = $.taskInfo.feedReachInit.hadFeedAmount / 10; //å·²ç»å–‚å…»äº†å‡ æ¬¡
  let needFeedTimes = 10 - finishedTimes; //è¿˜éœ€è¦å‡ æ¬¡
  let tryTimes = 20; //å°è¯•æ¬¡æ•°
  do {
    console.log(`è¿˜éœ€è¦æŠ•é£Ÿ${needFeedTimes}æ¬¡`);
    const response = await request('feedPets');
    console.log(`æœ¬æ¬¡æŠ•é£Ÿç»“æœ: ${JSON.stringify(response)}`);
    if (response.resultCode == 0 && response.code == 0) {
      needFeedTimes--;
    }
    if (response.resultCode == 3003 && response.code == 0) {
      console.log('å‰©ä½™ç‹—ç²®ä¸è¶³, æŠ•é£Ÿç»“æŸ');
      needFeedTimes = 0;
    }
    tryTimes--;
  } while (needFeedTimes > 0 && tryTimes > 0)
  console.log('æŠ•é£Ÿä»»åŠ¡ç»“æŸ...\n');
}
async function showMsg() {
  let ctrTemp;
  if ($.isNode() && process.env.PET_NOTIFY_CONTROL) {
    ctrTemp = `${process.env.PET_NOTIFY_CONTROL}` === 'false';
  } else if ($.getdata('jdPetNotify')) {
    ctrTemp = $.getdata('jdPetNotify') === 'false';
  } else {
    ctrTemp = `${jdNotify}` === 'false';
  }
  // jdNotify = `${notify.petNotifyControl}` === 'false' && `${jdNotify}` === 'false' && $.getdata('jdPetNotify') === 'false';
  if (ctrTemp) {
    $.msg($.name, subTitle, message, option);
    if ($.isNode()) {
      await notify.sendNotify(`${$.name} - è´¦å·${$.index} - ${$.nickName}`, `${subTitle}\n${message}`);
    }
  } else {
    $.log(`\n${message}\n`);
  }
}
getArrRandomly = (arr) => {
  var len = arr.length;
  for (var i = len - 1; i >= 0; i--) {
    var randomIndex = Math.floor(Math.random() * (i + 1));
    var itemIndex = arr[randomIndex];
    arr[randomIndex] = arr[i];
    arr[i] = itemIndex;
  }
  return arr;
}


getRandomArr = (arr=[],num) => {
  const tmpArr = getArrRandomly(arr);
  let arrList = [];
  for (let i = 0; i < num; i++) {
    arrList.push(tmpArr[i]);
  };
  return arrList;
}


function readShareCode() {
console.log(`å¼€å§‹è¯»å–æœ±ä¸½å¨œã€‚ã€‚ã€‚`)
return new Promise(async resolve => {
  $.get({url: `https://raw.githubusercontent.com/jd1994527314/iosrule/cs/JD_TG/MC.json`, 'timeout': 10000}, (err, resp, data) => {
    try {
      if (err) {
        console.log(`${JSON.stringify(err)}`)
        console.log(`${$.name} APIè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘è·¯é‡è¯•`)
      } else {
        if (data) {
          console.log(`éšæœºå–${randomCount}ä¸ªç æ”¾åˆ°æ‚¨å›ºå®šçš„äº’åŠ©ç åé¢(ä¸å½±å“å·²æœ‰å›ºå®šäº’åŠ©)`)
          data = JSON.parse(data);
        }
      }
    } catch (e) {
      $.logErr(e, resp)
    } finally {
      resolve(data);
    }
  })
  await $.wait(10000);
  resolve()
})
}
//æ ¼å¼åŒ–åŠ©åŠ›ç 
function shareCodesFormat() {
return new Promise(async resolve => {
  // console.log(`ç¬¬${$.index}ä¸ªäº¬ä¸œè´¦å·çš„åŠ©åŠ›ç :::${$.shareCodesArr[$.index - 1]}`)
  $.newShareCodes = [];
  const readShareCodeRes = await readShareCode();
  
  if (readShareCodeRes && readShareCodeRes.code === 200) {
$.newShareCodes = [...new Set([...$.newShareCodes, ...(getRandomArr(getArrRandomly(readShareCodeRes.data),randomCount)|| [])])];
  }
  
  console.log(`ç¬¬${$.index}ä¸ªäº¬ä¸œè´¦å·å°†è¦åŠ©åŠ›çš„å¥½å‹${JSON.stringify($.newShareCodes)}`)





  resolve();
})
}

function requireConfig() {
  return new Promise(resolve => {
    console.log('å¼€å§‹è·å–ä¸œä¸œèŒå® é…ç½®æ–‡ä»¶\n')
    notify = $.isNode() ? require('./sendNotify') : '';
    //Node.jsç”¨æˆ·è¯·åœ¨jdCookie.jså¤„å¡«å†™äº¬ä¸œck;
    const jdCookieNode = $.isNode() ? require('./jdCookie.js') : '';
    const jdPetShareCodes = $.isNode() ? require('./jdPetShareCodes.js') : '';
    //IOSç­‰ç”¨æˆ·ç›´æ¥ç”¨NobyDaçš„jd cookie
    if ($.isNode()) {
      Object.keys(jdCookieNode).forEach((item) => {
        if (jdCookieNode[item]) {
          cookiesArr.push(jdCookieNode[item])
        }
      })
      if (process.env.JD_DEBUG && process.env.JD_DEBUG === 'false') console.log = () => {};
    } else {
      let cookiesData = $.getdata('CookiesJD') || "[]";
      cookiesData = jsonParse(cookiesData);
      cookiesArr = cookiesData.map(item => item.cookie);
      cookiesArr.reverse();
      cookiesArr.push(...[$.getdata('CookieJD2'), $.getdata('CookieJD')]);
      cookiesArr.reverse();
      cookiesArr = cookiesArr.filter(item => item !== "" && item !== null && item !== undefined);
    }
    console.log(`å…±${cookiesArr.length}ä¸ªäº¬ä¸œè´¦å·\n`)
    if ($.isNode()) {
      Object.keys(jdPetShareCodes).forEach((item) => {
        if (jdPetShareCodes[item]) {
          jdPetShareArr.push(jdPetShareCodes[item])
        }
      })
    } else {
      const boxShareCodeArr = ['jd_pet1', 'jd_pet2', 'jd_pet3', 'jd_pet4', 'jd_pet5'];
      const boxShareCodeArr2 = ['jd2_pet1', 'jd2_pet2', 'jd2_pet3', 'jd2_pet4', 'jd2_pet5'];
      const isBox1 = boxShareCodeArr.some((item) => {
        const boxShareCode = $.getdata(item);
        return (boxShareCode !== undefined && boxShareCode !== null && boxShareCode !== '');
      });
      const isBox2 = boxShareCodeArr2.some((item) => {
        const boxShareCode = $.getdata(item);
        return (boxShareCode !== undefined && boxShareCode !== null && boxShareCode !== '');
      });
      isBox = isBox1 ? isBox1 : isBox2;
      if (isBox1) {
        let temp = [];
        for (const item of boxShareCodeArr) {
          if ($.getdata(item)) {
            temp.push($.getdata(item))
          }
        }
        jdPetShareArr.push(temp.join('@'));
      }
      if (isBox2) {
        let temp = [];
        for (const item of boxShareCodeArr2) {
          if ($.getdata(item)) {
            temp.push($.getdata(item))
          }
        }
        jdPetShareArr.push(temp.join('@'));
      }
    }
    // console.log(`jdPetShareArr::${JSON.stringify(jdPetShareArr)}`)
    // console.log(`jdPetShareArrè´¦å·é•¿åº¦::${jdPetShareArr.length}`)
    console.log(`æ‚¨æä¾›äº†${jdPetShareArr.length}ä¸ªè´¦å·çš„ä¸œä¸œèŒå® åŠ©åŠ›ç \n`);
    resolve()
  })
}
function TotalBean() {
  return new Promise(async resolve => {
    const options = {
      "url": `https://wq.jd.com/user/info/QueryJDUserInfo?sceneval=2`,
      "headers": {
        "Accept": "application/json,text/plain, */*",
        "Content-Type": "application/x-www-form-urlencoded",
        "Accept-Encoding": "gzip, deflate, br",
        "Accept-Language": "zh-cn",
        "Connection": "keep-alive",
        "Cookie": cookie,
        "Referer": "https://wqs.jd.com/my/jingdou/my.shtml?sceneval=2",
        "User-Agent": $.isNode() ? (process.env.JD_USER_AGENT ? process.env.JD_USER_AGENT : (require('./USER_AGENTS').USER_AGENT)) : ($.getdata('JDUA') ? $.getdata('JDUA') : "jdapp;iPhone;9.2.2;14.2;%E4%BA%AC%E4%B8%9C/9.2.2 CFNetwork/1206 Darwin/20.1.0")
      }
    }
    $.post(options, (err, resp, data) => {
      try {
        if (err) {
          console.log(`${JSON.stringify(err)}`)
          console.log(`${$.name} APIè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘è·¯é‡è¯•`)
        } else {
          if (data) {
            data = JSON.parse(data);
            if (data['retcode'] === 13) {
              $.isLogin = false; //cookieè¿‡æœŸ
              return
            }
            $.nickName = data['base'].nickname;
          } else {
            console.log(`äº¬ä¸œæœåŠ¡å™¨è¿”å›ç©ºæ•°æ®`)
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve();
      }
    })
  })
}
// è¯·æ±‚
async function request(function_id, body = {}) {
  await $.wait(3000); //æ­‡å£æ°”å„¿, ä¸ç„¶ä¼šæŠ¥æ“ä½œé¢‘ç¹
  return new Promise((resolve, reject) => {
    $.post(taskUrl(function_id, body), (err, resp, data) => {
      try {
        if (err) {
          console.log('\nä¸œä¸œèŒå® : APIæŸ¥è¯¢è¯·æ±‚å¤±è´¥ â€¼ï¸â€¼ï¸');
          console.log(JSON.stringify(err));
          $.logErr(err);
        } else {
          data = JSON.parse(data);
        }
      } catch (e) {
        $.logErr(e, resp);
      } finally {
        resolve(data)
      }
    })
  })
}
// function taskUrl(function_id, body = {}) {
//   return {
//     url: `${JD_API_HOST}?functionId=${function_id}&appid=wh5&loginWQBiz=pet-town&body=${escape(JSON.stringify(body))}`,
//     headers: {
//       Cookie: cookie,
//       UserAgent: $.isNode() ? (process.env.JD_USER_AGENT ? process.env.JD_USER_AGENT : (require('./USER_AGENTS').USER_AGENT)) : ($.getdata('JDUA') ? $.getdata('JDUA') : "jdapp;iPhone;9.2.2;14.2;%E4%BA%AC%E4%B8%9C/9.2.2 CFNetwork/1206 Darwin/20.1.0"),
//     }
//   };
// }
function taskUrl(function_id, body = {}) {
  body["version"] = 2;
  body["channel"] = 'app';
  return {
    url: `${JD_API_HOST}?functionId=${function_id}`,
    body: `body=${escape(JSON.stringify(body))}&appid=wh5&loginWQBiz=pet-town&clientVersion=9.0.4`,
    headers: {
      'Cookie': cookie,
      'User-Agent': $.isNode() ? (process.env.JD_USER_AGENT ? process.env.JD_USER_AGENT : (require('./USER_AGENTS').USER_AGENT)) : ($.getdata('JDUA') ? $.getdata('JDUA') : "jdapp;iPhone;9.2.2;14.2;%E4%BA%AC%E4%B8%9C/9.2.2 CFNetwork/1206 Darwin/20.1.0"),
      'Host': 'api.m.jd.com',
      'Content-Type': 'application/x-www-form-urlencoded',
    }
  };
}
function jsonParse(str) {
  if (typeof str == "string") {
    try {
      return JSON.parse(str);
    } catch (e) {
      console.log(e);
      $.msg($.name, '', 'è¯·å‹¿éšæ„åœ¨BoxJsè¾“å…¥æ¡†ä¿®æ”¹å†…å®¹\nå»ºè®®é€šè¿‡è„šæœ¬å»è·å–cookie')
      return [];
    }
  }
}
// prettier-ignore
function Env(t,e){"undefined"!=typeof process&&JSON.stringify(process.env).indexOf("GITHUB")>-1&&process.exit(0);class s{constructor(t){this.env=t}send(t,e="GET"){t="string"==typeof t?{url:t}:t;let s=this.get;return"POST"===e&&(s=this.post),new Promise((e,i)=>{s.call(this,t,(t,s,r)=>{t?i(t):e(s)})})}get(t){return this.send.call(this.env,t)}post(t){return this.send.call(this.env,t,"POST")}}return new class{constructor(t,e){this.name=t,this.http=new s(this),this.data=null,this.dataFile="box.dat",this.logs=[],this.isMute=!1,this.isNeedRewrite=!1,this.logSeparator="\n",this.startTime=(new Date).getTime(),Object.assign(this,e),this.log("",`ğŸ””${this.name}, å¼€å§‹!`)}isNode(){return"undefined"!=typeof module&&!!module.exports}isQuanX(){return"undefined"!=typeof $task}isSurge(){return"undefined"!=typeof $httpClient&&"undefined"==typeof $loon}isLoon(){return"undefined"!=typeof $loon}toObj(t,e=null){try{return JSON.parse(t)}catch{return e}}toStr(t,e=null){try{return JSON.stringify(t)}catch{return e}}getjson(t,e){let s=e;const i=this.getdata(t);if(i)try{s=JSON.parse(this.getdata(t))}catch{}return s}setjson(t,e){try{return this.setdata(JSON.stringify(t),e)}catch{return!1}}getScript(t){return new Promise(e=>{this.get({url:t},(t,s,i)=>e(i))})}runScript(t,e){return new Promise(s=>{let i=this.getdata("@chavy_boxjs_userCfgs.httpapi");i=i?i.replace(/\n/g,"").trim():i;let r=this.getdata("@chavy_boxjs_userCfgs.httpapi_timeout");r=r?1*r:20,r=e&&e.timeout?e.timeout:r;const[o,h]=i.split("@"),n={url:`http://${h}/v1/scripting/evaluate`,body:{script_text:t,mock_type:"cron",timeout:r},headers:{"X-Key":o,Accept:"*/*"}};this.post(n,(t,e,i)=>s(i))}).catch(t=>this.logErr(t))}loaddata(){if(!this.isNode())return{};{this.fs=this.fs?this.fs:require("fs"),this.path=this.path?this.path:require("path");const t=this.path.resolve(this.dataFile),e=this.path.resolve(process.cwd(),this.dataFile),s=this.fs.existsSync(t),i=!s&&this.fs.existsSync(e);if(!s&&!i)return{};{const i=s?t:e;try{return JSON.parse(this.fs.readFileSync(i))}catch(t){return{}}}}}writedata(){if(this.isNode()){this.fs=this.fs?this.fs:require("fs"),this.path=this.path?this.path:require("path");const t=this.path.resolve(this.dataFile),e=this.path.resolve(process.cwd(),this.dataFile),s=this.fs.existsSync(t),i=!s&&this.fs.existsSync(e),r=JSON.stringify(this.data);s?this.fs.writeFileSync(t,r):i?this.fs.writeFileSync(e,r):this.fs.writeFileSync(t,r)}}lodash_get(t,e,s){const i=e.replace(/\[(\d+)\]/g,".$1").split(".");let r=t;for(const t of i)if(r=Object(r)[t],void 0===r)return s;return r}lodash_set(t,e,s){return Object(t)!==t?t:(Array.isArray(e)||(e=e.toString().match(/[^.[\]]+/g)||[]),e.slice(0,-1).reduce((t,s,i)=>Object(t[s])===t[s]?t[s]:t[s]=Math.abs(e[i+1])>>0==+e[i+1]?[]:{},t)[e[e.length-1]]=s,t)}getdata(t){let e=this.getval(t);if(/^@/.test(t)){const[,s,i]=/^@(.*?)\.(.*?)$/.exec(t),r=s?this.getval(s):"";if(r)try{const t=JSON.parse(r);e=t?this.lodash_get(t,i,""):e}catch(t){e=""}}return e}setdata(t,e){let s=!1;if(/^@/.test(e)){const[,i,r]=/^@(.*?)\.(.*?)$/.exec(e),o=this.getval(i),h=i?"null"===o?null:o||"{}":"{}";try{const e=JSON.parse(h);this.lodash_set(e,r,t),s=this.setval(JSON.stringify(e),i)}catch(e){const o={};this.lodash_set(o,r,t),s=this.setval(JSON.stringify(o),i)}}else s=this.setval(t,e);return s}getval(t){return this.isSurge()||this.isLoon()?$persistentStore.read(t):this.isQuanX()?$prefs.valueForKey(t):this.isNode()?(this.data=this.loaddata(),this.data[t]):this.data&&this.data[t]||null}setval(t,e){return this.isSurge()||this.isLoon()?$persistentStore.write(t,e):this.isQuanX()?$prefs.setValueForKey(t,e):this.isNode()?(this.data=this.loaddata(),this.data[e]=t,this.writedata(),!0):this.data&&this.data[e]||null}initGotEnv(t){this.got=this.got?this.got:require("got"),this.cktough=this.cktough?this.cktough:require("tough-cookie"),this.ckjar=this.ckjar?this.ckjar:new this.cktough.CookieJar,t&&(t.headers=t.headers?t.headers:{},void 0===t.headers.Cookie&&void 0===t.cookieJar&&(t.cookieJar=this.ckjar))}get(t,e=(()=>{})){t.headers&&(delete t.headers["Content-Type"],delete t.headers["Content-Length"]),this.isSurge()||this.isLoon()?(this.isSurge()&&this.isNeedRewrite&&(t.headers=t.headers||{},Object.assign(t.headers,{"X-Surge-Skip-Scripting":!1})),$httpClient.get(t,(t,s,i)=>{!t&&s&&(s.body=i,s.statusCode=s.status),e(t,s,i)})):this.isQuanX()?(this.isNeedRewrite&&(t.opts=t.opts||{},Object.assign(t.opts,{hints:!1})),$task.fetch(t).then(t=>{const{statusCode:s,statusCode:i,headers:r,body:o}=t;e(null,{status:s,statusCode:i,headers:r,body:o},o)},t=>e(t))):this.isNode()&&(this.initGotEnv(t),this.got(t).on("redirect",(t,e)=>{try{if(t.headers["set-cookie"]){const s=t.headers["set-cookie"].map(this.cktough.Cookie.parse).toString();s&&this.ckjar.setCookieSync(s,null),e.cookieJar=this.ckjar}}catch(t){this.logErr(t)}}).then(t=>{const{statusCode:s,statusCode:i,headers:r,body:o}=t;e(null,{status:s,statusCode:i,headers:r,body:o},o)},t=>{const{message:s,response:i}=t;e(s,i,i&&i.body)}))}post(t,e=(()=>{})){if(t.body&&t.headers&&!t.headers["Content-Type"]&&(t.headers["Content-Type"]="application/x-www-form-urlencoded"),t.headers&&delete t.headers["Content-Length"],this.isSurge()||this.isLoon())this.isSurge()&&this.isNeedRewrite&&(t.headers=t.headers||{},Object.assign(t.headers,{"X-Surge-Skip-Scripting":!1})),$httpClient.post(t,(t,s,i)=>{!t&&s&&(s.body=i,s.statusCode=s.status),e(t,s,i)});else if(this.isQuanX())t.method="POST",this.isNeedRewrite&&(t.opts=t.opts||{},Object.assign(t.opts,{hints:!1})),$task.fetch(t).then(t=>{const{statusCode:s,statusCode:i,headers:r,body:o}=t;e(null,{status:s,statusCode:i,headers:r,body:o},o)},t=>e(t));else if(this.isNode()){this.initGotEnv(t);const{url:s,...i}=t;this.got.post(s,i).then(t=>{const{statusCode:s,statusCode:i,headers:r,body:o}=t;e(null,{status:s,statusCode:i,headers:r,body:o},o)},t=>{const{message:s,response:i}=t;e(s,i,i&&i.body)})}}time(t,e=null){const s=e?new Date(e):new Date;let i={"M+":s.getMonth()+1,"d+":s.getDate(),"H+":s.getHours(),"m+":s.getMinutes(),"s+":s.getSeconds(),"q+":Math.floor((s.getMonth()+3)/3),S:s.getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(s.getFullYear()+"").substr(4-RegExp.$1.length)));for(let e in i)new RegExp("("+e+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?i[e]:("00"+i[e]).substr((""+i[e]).length)));return t}msg(e=t,s="",i="",r){const o=t=>{if(!t)return t;if("string"==typeof t)return this.isLoon()?t:this.isQuanX()?{"open-url":t}:this.isSurge()?{url:t}:void 0;if("object"==typeof t){if(this.isLoon()){let e=t.openUrl||t.url||t["open-url"],s=t.mediaUrl||t["media-url"];return{openUrl:e,mediaUrl:s}}if(this.isQuanX()){let e=t["open-url"]||t.url||t.openUrl,s=t["media-url"]||t.mediaUrl;return{"open-url":e,"media-url":s}}if(this.isSurge()){let e=t.url||t.openUrl||t["open-url"];return{url:e}}}};if(this.isMute||(this.isSurge()||this.isLoon()?$notification.post(e,s,i,o(r)):this.isQuanX()&&$notify(e,s,i,o(r))),!this.isMuteLog){let t=["","==============ğŸ“£ç³»ç»Ÿé€šçŸ¥ğŸ“£=============="];t.push(e),s&&t.push(s),i&&t.push(i),console.log(t.join("\n")),this.logs=this.logs.concat(t)}}log(...t){t.length>0&&(this.logs=[...this.logs,...t]),console.log(t.join(this.logSeparator))}logErr(t,e){const s=!this.isSurge()&&!this.isQuanX()&&!this.isLoon();s?this.log("",`â—ï¸${this.name}, é”™è¯¯!`,t.stack):this.log("",`â—ï¸${this.name}, é”™è¯¯!`,t)}wait(t){return new Promise(e=>setTimeout(e,t))}done(t={}){const e=(new Date).getTime(),s=(e-this.startTime)/1e3;this.log("",`ğŸ””${this.name}, ç»“æŸ! ğŸ•› ${s} ç§’`),this.log(),(this.isSurge()||this.isQuanX()||this.isLoon())&&$done(t)}}(t,e)}
