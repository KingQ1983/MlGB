/*
英语演讲：改变一下，仰望星空
文章来源：未知 文章作者：enread 发布时间：2020-05-11 07:03 字体： [大 中 小]　 进入论坛
(单词翻译:双击或拖选)
The sky is inherently democratic.
夜空，是人类与生俱来的共享资源。
It's accessible, in principle, anyway, by anyone, everywhere, just simply by the act of looking up.
原则上来说，任何人、在任何地方，都可以欣赏夜空的美，你只需轻轻抬头仰望。
But like so many beautiful things around us, it's slipping away from us,
然而，如同我们身边很多其它美丽的事物一样，夜空正在逐渐消逝，
and we haven't even noticed, because we're honestly not really looking.
而我们却未曾察觉，因为，我们根本看都没看一眼。
So what do we look at instead? Well, we look at our phones, we look at our computers, we look at screens of all kinds.
那我们看的究竟是什么呢？我们在看手机、玩电脑，我们注视着各种各样的电子屏幕。
And honestly, we rarely even take the trouble to look up enough to see each other,
说实在的，我们甚至很少费心去抬头注视彼此，
let alone taking that next step to looking up at the actual sky.
更不要说走出房门、抬头仰望真正的天空了。
Now, there's a tendency to think that the loss of our dark night skies is the inevitable1 outcome of progress, change, technology.
越来越多的人认为，夜空的消逝是科技进步、社会发展的必然结果。
And you know, that's just simply not true. Later on, I'll tell you why.
但这并不是真正的原因。接下来，我将告诉你为什么。
But first, I want to tell you about my experience of the dark night sky.
首先，我想给你们讲讲我自己有关夜空的经历。
I never saw a truly dark night sky until I was 15. I was here, in Arizona.
我直到十五岁时，才见过真正的夜空。当时，我就在亚利桑那州。
I was on a road trip; I pulled over somewhere. I have no idea where I was, except I know what state.
那是一次旅途，我们在一个地方靠边停了车。当时除了州名以外，我对身在何处一无所知。
And I looked up, and the sky was just filled with an impossible number of stars.
就那么不经意地抬头一望，我看到了布满繁星的夜空！
You see, I'm from New York City, and in New York, you can see the moon, you can see a couple of stars.
想想看，我来自纽约，在那个城市，你只能看到月亮和几颗“零星”。
More often than not, they turn out to be airplanes when they land.
而且通常当“零星”降落时，你才发现，它们其实是飞机。
But there's really not much else.
除此之外，也没什么其它东西了。
As a result, most of my colleagues who are astronomers2 spent at least part of their youth looking up at the sky in their backyard.
我的大多数天文学家同事们，至少都有过一段夜晚在自家后院数星星的童年时光。
I never really had that experience, and, as a result, I'm really disappointing on camping trips.
而我却从未有过那种经历，所以在露营旅途中，我的表现令人大失所望。
I don't really know many constellations3.
关于星座方面的知识极其有限。
The ones I do know, you probably know them, too.
而我所知道的为数不多的几个星座，相信在座的各位也都耳熟能详。
But I'll never forget that experience of the first time I saw the dark night sky.
但我永远不会忘记平生第一次看到夜空的经历。
And I was just flabbergasted at how many stars there were. And I felt tiny.
那漫天的繁星深深震撼了我，让我感到自己无比渺小。
Then I also felt like, "Where's this been hiding this whole time? Who's been hiding this sky from me?"
接下来，我就有了这样的疑惑：这些奇景一直以来被藏在了哪里？是谁藏匿了这样的天空？
Of course, the answer is obvious if you think about it or if you look at the picture on the left,
不过仔细一想，答案其实显而易见，或者看一下左边的照片就明白了，
where you're seeing the same neighborhood taken during a blackout versus4 on an ordinary night.
这是同一街区停电时拍摄的夜空，右边是普通夜晚拍摄的夜空照片。
You can't see the stars if you drown them out with light.
当星星被灯光淹没时，你自然就看不到它们。
Take a look at our planet. This is our planet from space.
现在请审视一下我们的地球，这是从太空拍摄的地球。
Unlike stars, which are hot and glow invisible light so we can see them,
恒星发出热量和不可见光，所以我们能看到它们，
our planet is, astronomically5 speaking, pretty cold. So it doesn't really glow.
而地球与恒星不同，从天文学上讲，地球很冷，所以其自身并不发光。
When you see the planet looking like a blue-green marble the way it does in this picture,
当你看到图中展现的这颗如蓝绿色大理石般的地球时，
you're seeing it because the sunlight is reflecting off of it,
你能看见它是因为它反射了太阳光的缘故。
and that's why you can see the oceans, the clouds, the land.
这也是为什么你能看到海洋、云朵和陆地。
So if the sun wasn't shining on it, we wouldn't be able to see the earth, right? Or would we?
也就是说，如果没有太阳的照射，我们就看不到地球了，对吗？或者，我们依然能看到它？
This is our earth at night, and it is one of the most striking examples of how we have affected6 our planet on a global scale.
这是夜晚的地球，这是人类在全球范围内对地球造成显著影响的例子之一。
You can see light spidering out across the globe everywhere.
你可以看到光亮散播到了全球的各个角落，
Now, of course, there are broad expanses of ocean that are still dark,
当然，现在广阔的海洋依旧处于黑暗中，
and in many underdeveloped areas there's still darkness.
很多不发达的地区看起来也是漆黑一片。
But you'll notice that this is a pretty global effect.
但你会发现这其实已经成为了全球现象。
We tend to think, when we think of places being lit up, of very extreme examples -- Times Square, the Vegas Strip.
当提到灯火通明的地方时，我们总会想起那些最极端的例子，比如时代广场、拉斯维加斯大道。
But really what that picture shows you is that it's not just these extreme examples, it's anywhere that uses outdoor lighting7.
但那张整个地球的照明情况图片显示的不仅仅是这几个极端个例，而是任何使用户外照明的地方。
This tends to be a really dramatic effect on the ground.
这往往给地球表面带来真正巨大的影响。
To understand why, all you really have to do is think about the shape of a lightbulb.
想知道为什么，你只需想想灯泡的形状。
The lightbulb, for all practical purposes, is more or less round.
为了实用的目的，灯泡基本上都是圆的。
This is great for its original intended purpose of lighting up the indoors.
这正符合它最初的目的，室内照明。
You turn it on, light goes everywhere. An individual light bulb can light up your whole room, more or less.
你打开灯，灯光照射到房间的每个角落。一个灯泡就能照亮整个房间，只是明暗程度的差异。
Now, that's great if you're lighting the indoors, but in its application in outdoor lighting,
如果你想照亮室内，这确实非常有效；但当我们用于室外照明时，
that traditional shape of the light bulb, the sort of globe that spreads light everywhere, is actually very inefficient8.
传统的灯泡形状，即那种向四周传播光线的球形灯泡，其实是十分低效的。
When you're outdoors, mostly what you care about is lighting the ground beneath you and your immediate9 surroundings.
当你身处室外时，你最关心的是照亮你脚下的地面和周围的环境。
All of that light that gets scattered10 outwards11 and upwards12 doesn't actually help you light the area around you.
所有那些分散向外或向上的光，都并不能帮你有效地照亮你周围的区域。
What it does is scatters13 up into the sky and becomes what we call "light pollution."
它只是将光线散射到天空，造成我们所说的“光污染”。
Even if you don't care anything about stargazing, this should worry you,
即使你不在意星象观测，你也应该关心光污染，
because it means that 60-70% of the energy we use to light the outdoors is wasted by blotting14 out the stars.
因为，它意味着我们用于室外照明的60-70%的能量被浪费在屏蔽夜晚的星光了。
Now, like I said, I'm a big fan of technology.
 
正如我所说的，我是个大科技迷。
Obviously, I use technology every day; I'm a scientist.
作为一个科学家，显然每天我都使用高科技。
And there's this tendency to say that it's progress that -- you know, I'm not suggesting we're going to all go live by candlelight.
大家倾向于认为这是进步--我并非建议大家在烛光下生活。
Indeed, technology is allowing us to access the sky in ways that are impossible otherwise.
确实，科技使我们能够接近天空。
One of the greatest examples of this is, of course, the Hubble Space Telescope.
用一种只有科技能够做到的方式，当然，最伟大的例子就是哈勃太空望远镜。
The Hubble went up into space, it returns pictures daily,
哈勃望远镜被发射进入太空，每天都传回大量照片，
and it allows us to see things that we are incapable15 of seeing with our naked eye,
让我们看到太空的事物，这些都是我们肉眼所看不到的，
in ways that we've never been able to do before in all of human history.
在人类历史的任何阶段，我们都从没这么做过。
Other examples of this would be planetarium16 shows.
其它类似的例子当然还有天体展示。
In the past couple of years, planetarium shows have become more high-tech17 with these great visualizations,
在过去的几年里，借助这些超棒的可视化信息，天体展示变得越来越高科技化，
and even though this isn't access directly to the sky, it's at least access to our knowledge about the sky.
即使这并不是直接亲身接触天空，但至少让我们获得了关于天空的知识。
And indeed, we can experience the sky in a planetarium in a way that is impossible for us to do just sitting out and looking in the dark.
的确，我们可以在天文馆体验那种坐在室外、望向漆黑的夜空所体验不到的感觉。
All of you have heard of the Hubble Space Telescope and of planetariums18.
你们大概都听说过哈勃太空望远镜和天文馆。
But there are also ways for technology to enable participation19 in people's experience of the sky that you may not be familiar with.
但是也有一些技术可以让人们参与到关于天空的、你可能不熟悉的体验中。
These are called "citizen science projects."
这就是所谓的“平民科学项目”。
Citizen science is when large research projects put their data online, teach ordinary people, like you, to go and interact with that data
平民科学是一个大的项目，他们把数据放到互联网上，教像在座各位这样的普通人去与数据进行交互，
and actually contribute to the research by making interesting or necessary characterizations about it.
通过给数据添加有趣或必要的特征，进而对研究做出贡献。
One such example of this is what I'm showing here, called "Galaxy20 Zoo."
类似的例子就是我现在展示的“银河动物园”项目。
Galaxy Zoo is a project where people get a 20-minute -- even less than that, actually
银河动物园项目是这样的：人们经过20分钟的指导--实际上少于20分钟，
tutorial on how to interact with these images of galaxies21.
学习关于如何与这些星系的图像进行交互。
They learn to annotate22 the images, and within a couple of minutes, they're up and running,
他们学习为图像做注释，在几分钟内，他们就能着手开始工作，
and they're making really useful categorizations and classifications of these galaxies.
而且真正能够对这些星系进行有用的归类和划分。
Now, it's easy to understand why Galaxy Zoo would be an easy sell for people to be involved with:
很容易就能理解为何“银河动物园”很容易被参与其中的人所接受：
it involves pretty pictures; galaxies are, generally speaking, pretty attractive.
它包含了漂亮的图片；通常来说，星系的确很吸引人。
However, there are many other flavors of citizen science projects that people have delved23 into that have varying levels of abstraction,
然而，还有很多其他类型的平民科学项目，人们探究过的这些项目抽象程度各不相同，
that you wouldn't necessarily think people would jump at.
你会觉得人们不太会立刻参与这些项目。
One such example of this is the citizen science project associated with the mission that I'm part of, called the Kepler Mission.
一个类似的例子就是与我参加的任务相关的一个平民科学项目，叫做“开普勒任务”。
Kepler is a space telescope and it looks for planets around other stars by measuring the light from those stars very precisely24.
开普勒是一个太空望远镜，它通过精确测量恒星的光线（变化）来寻找恒星周围的行星。
And we're looking for the dimmings caused by stars blocking off some of that light.
我们在寻找恒星因为光线被（围绕其运转的行星）阻挡而发生的微暗现象。
We have an associated citizen science project called "Planet Hunters."
我们有一个与此相关的“行星猎手”平民科学项目。
Planet Hunters gives you, like Galaxy Zoo, a short tutorial, and within a couple of minutes, you're up and running;
类似于银河动物园，这个项目也会提供给你一个短教程，几分钟之后，你就可以开始工作；
you're looking at data from the Kepler Mission and looking for planets.
你需要观察来自开普勒任务的数据，并寻找行星。
The idea behind this is an easy sell, right?
背后的想法很容易被接受，对吗？
But the actual process of planet-hunting involves a lot of looking at graphs,
但探索行星的实际过程包含对大量图表进行观察分析，
like the one I'm showing you here, and annotating25 them.
就像这里我向你们展示的一样，需要去分析和注释它们。
I do this all day and that doesn't even sound that interesting to me.
我整天都做这些工作，所以已经不觉得那么有趣了。
However, not only are people interested in doing this,
然而，人们不仅对此很感兴趣，
but the citizen scientists that work with Planet Hunters have actually found planets in the data that would have gone undiscovered otherwise.
而且参与“行星猎手”项目的平民科学家们在数据中真的发现了行星，多亏了他们，才不至于错失发现这些行星的机会。
This is an author list from the paper that they published of the planet they discovered.
这是他们发表的关于所发现行星论文中的作者列表。
You'll see that all the people who contributed are listed below,
你会看到，所有对此做出贡献的人们都在以下名单中列出，
and it's sort of an odd amalgam26 of people's real names and their log-in names.
名单有点像人们真实姓名和他们登录名的奇怪组合。
You'll notice if you look carefully, this is the first academic acknowledgment of the importance of Irish coffee in the discovery process.
如果仔细观察，你会发现这是学术圈第一次认可爱尔兰咖啡在发现行星过程中的重要性。
I don't want to give you the idea that these are some out-of-work scientists or just a bunch of nerds that are really into this.
我不想给你这样的错觉，以为这些只是一些失业的科学家或一些书呆子才会痴迷的项目。
There are 60,000 people who participate in these projects, and most of them don't have technical backgrounds.
其实，一共有6万人参与了这些项目，其中大部分人都没有技术背景。
So clearly, what this is feeding into is people's curiosity and their willingness to be part of the scientific discovery process.
显然，人们参与其中是因为好奇心驱使，还有他们参与科学发现过程的意愿。
People want to do this. But all of this technology and all these digitally mediated27 ways of experiencing the sky
人们想去做这样的事情。但是所有这些技术，以及所有这些体验天空的数码媒介方式，
still have something of a feel to me like looking at an animal in a zoo.
仍带给我一种像在动物园看动物的感觉。
It's a valid28 way of experiencing that thing -- indeed, the lion in the cage is still real, the Hubble images are indeed real,
这是体验天空的有效方式，确实，笼里的狮子依旧是真实的，哈勃图片也确实是真实的，
and you can get closer to a lion in a zoo than you can in the wild. However, it's missing something.
而且，你在动物园里比在野外更接近狮子。然而，这里缺少了一些东西。
It's missing that savage29 beauty of experiencing that very thing in the wild for yourself, unmediated by a screen.
缺少你在野外亲身体验到的那种野性之美，未曾经过荧屏这层媒介。
The experience of looking up and knowing that the sky you're looking at surrounds every known living thing in the universe is very profound.
 
仰望天空，并认识到你正观看的天空包围着宇宙中所有的已知生物，这种感受意义深远。
Think about that for a moment. We are the only planet we know of that has life on it.
试想一下，我们是唯一已知的存在生命的星球。
The sky that you see is shared by every other living thing that we know of in existence.
你所看到的天空，是与已知世间万物共享的，
One of the things that I really like about my work is that
我真正喜欢自己职业的一点是，
it allows me to step back from my every day and to experience the larger context,
它让我抛开日常的生活，去体验更丰富的内涵，
this feeling that just as we go out and try to find planets in the universe that might be like ours,
这种感觉就好像我们遨游宇宙去寻找新的行星，可能和地球一样的星球，
it always reminds me of how precious what we have here is.
这总是提醒我现在的生活有多么珍贵。
Our night sky is like a natural resource, it's as though it's a park that you can visit without ever having to travel there.
我们的夜空就像自然资源，就像一个无须经历旅游劳顿就可以参观的公园。
But like any natural resource,
但是，就像其他的自然资源一样，
if we don't protect it, if we don't preserve it and treasure it, it will slip away from us and be gone.
如果我们不去保护它、保存它和珍惜它，它将会从我们身边消失。
So if you're interested in this, and this is something you want to learn more about,
因此，如果你们对此感兴趣，如果这也是你想多了解的东西，
I encourage you in particular to visit darksky.org
我特别鼓励你们去访问网站“darksky.org”，
and to learn more about the choices you can make that can protect the dark night sky,
去学习更多关于你能做出的选择，来保护夜空，
because it belongs to everyone, it belongs to all of us, and therefore, it's ours to experience as we wish.
因为它属于每个人，属于我们所有人，所以，我们根据自己的愿望去行动。
And it's also ours to lose. Thank you.
成败的责任，都在于我们自己。谢谢！


口袋书店
活动入口：京东app首页-京东图书-右侧口袋书店

============Quantumultx===============
[task_local]
#口袋书店
1 8,12,18 * * * https://gitee.com/lxk0301/jd_scripts/raw/master/jd_bookshop.js, tag=口袋书店, img-url=https://raw.githubusercontent.com/Orz-3/task/master/jd.png, enabled=true

================Loon==============
[Script]
cron "1 8,12,18 * * *" script-path=https://gitee.com/lxk0301/jd_scripts/raw/master/jd_bookshop.js,tag=口袋书店

===============Surge=================
口袋书店 = type=cron,cronexp="1 8,12,18 * * *",wake-system=1,timeout=3600,script-path=https://gitee.com/lxk0301/jd_scripts/raw/master/jd_bookshop.js

============小火箭=========
口袋书店 = type=cron,script-path=https://gitee.com/lxk0301/jd_scripts/raw/master/jd_bookshop.js, cronexpr="1 8,12,18* * *", timeout=3600, enable=true
 */
const $ = new Env('口袋书店');
const notify = $.isNode() ? require('./sendNotify') : '';
const jdCookieNode = $.isNode() ? require('./jdCookie.js') : '';
//Node.js用户请在jdCookie.js处填写京东ck;
//IOS等用户直接用NobyDa的jd cookie
let cookiesArr = [], cookie = '', message;
const ACT_ID = 'dz2010100034444201', shareUuid = '28a699ac78d74aa3b31f7103597f8927'
let ADD_CART = false
ADD_CART = $.isNode() ? (process.env.PURCHASE_SHOPS ? process.env.PURCHASE_SHOPS : ADD_CART) : ($.getdata("ADD_CART") ? $.getdata("ADD_CART") : ADD_CART);
// 加入购物车开关，与东东小窝共享

let inviteCodes = [
  '28a699ac78d74aa3b31f7103597f8927@2f14ee9c92954cf79829320dd482bf49@fdf827db272543d88dbb51a505c2e869@ce2536153a8742fb9e8754a9a7d361da@38ba4e7ba8074b78851e928af2b4f6b2',
  '28a699ac78d74aa3b31f7103597f8927@2f14ee9c92954cf79829320dd482bf49@fdf827db272543d88dbb51a505c2e869'
]

if ($.isNode()) {
  Object.keys(jdCookieNode).forEach((item) => {
    cookiesArr.push(jdCookieNode[item])
  })
  if (process.env.JD_DEBUG && process.env.JD_DEBUG === 'false') console.log = () => {
  };
} else {
  let cookiesData = $.getdata('CookiesJD') || "[]";
  cookiesData = jsonParse(cookiesData);
  cookiesArr = cookiesData.map(item => item.cookie);
  cookiesArr.reverse();
  cookiesArr.push(...[$.getdata('CookieJD2'), $.getdata('CookieJD')]);
  cookiesArr.reverse();
  cookiesArr = cookiesArr.filter(item => item !== "" && item !== null && item !== undefined);
}

!(async () => {
  if (!cookiesArr[0]) {
    $.msg($.name, '【提示】请先获取京东账号一cookie\n直接使用NobyDa的京东签到获取', 'https://bean.m.jd.com/', {"open-url": "https://bean.m.jd.com/"});
    return;
  }
  $.shareCodesArr = []
  await requireConfig()
  for (let i = 0; i < cookiesArr.length; i++) {
    if (cookiesArr[i]) {
      cookie = cookiesArr[i];
      $.UserName = decodeURIComponent(cookie.match(/pt_pin=(.+?);/) && cookie.match(/pt_pin=(.+?);/)[1])
      $.index = i + 1;
      $.isLogin = true;
      $.nickName = '';
      message = '';
      await TotalBean();
      console.log(`\n******开始【京东账号${$.index}】${$.nickName || $.UserName}*********\n`);
      if (!$.isLogin) {
        $.msg($.name, `【提示】cookie已失效`, `京东账号${$.index} ${$.nickName || $.UserName}\n请重新登录获取\nhttps://bean.m.jd.com/`, {"open-url": "https://bean.m.jd.com/"});
        if ($.isNode()) {
          await notify.sendNotify(`${$.name}cookie已失效 - ${$.UserName}`, `京东账号${$.index} ${$.UserName}\n请重新登录获取cookie`);
        }
        continue
      }
      await shareCodesFormat()
      await jdBeauty()
    }
  }
})()
  .catch((e) => {
    $.log('', `❌ ${$.name}, 失败! 原因: ${e}!`, '')
  })
  .finally(() => {
    $.done();
  })

async function jdBeauty() {
  $.score = 0
  await getIsvToken()
  await getIsvToken2()
  await getActCk()
  await getActInfo()
  await getToken()
  await getUserInfo()
  await getActContent(false, shareUuid)
  if ($.exit) return
  await doHelpList()
  await getAllBook()
  await getMyBook()
  await getActContent(true)
  if ($.gold > 800) {
    console.log(`金币大于800，去抽奖`)
    while ($.gold >= 800) {
      await draw()
      await $.wait(1000)
      $.gold -= 800
    }
  }
  if($.userInfo.storeGold) await chargeGold()
  await helpFriends()
  await showMsg();
}

async function helpFriends() {
  for (let code of $.newShareCodes) {
    if (!code) continue
    console.log(`去助力好友${code}`)
    await getActContent(true, code)
    await $.wait(500)
  }
}

// 获得IsvToken
function getIsvToken() {
  return new Promise(resolve => {
    let body = 'body=%7B%22to%22%3A%22https%3A%5C%2F%5C%2Flzdz-isv.isvjcloud.com%5C%2Fdingzhi%5C%2Fbook%5C%2Fdevelop%5C%2Factivity%3FactivityId%3Ddz2010100034444201%22%2C%22action%22%3A%22to%22%7D&build=167490&client=apple&clientVersion=9.3.2&openudid=53f4d9c70c1c81f1c8769d2fe2fef0190a3f60d2&sign=f3eb9660e798c20372734baf63ab55f2&st=1610267023622&sv=111'
    $.post(jdUrl('genToken', body), async (err, resp, data) => {
      try {
        if (err) {
          console.log(`${$.name} API请求失败，请检查网路重试`)
        } else {
          if (safeGet(data)) {
            data = JSON.parse(data);
            $.isvToken = data['tokenKey']
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve(data);
      }
    })
  })
}

// 获得对应游戏的访问Token
function getIsvToken2() {
  return new Promise(resolve => {
    let body = 'body=%7B%22url%22%3A%22https%3A%5C%2F%5C%2Flzdz-isv.isvjcloud.com%22%2C%22id%22%3A%22%22%7D&build=167490&client=apple&clientVersion=9.3.2&openudid=53f4d9c70c1c81f1c8769d2fe2fef0190a3f60d2&sign=6050f8b81f4ba562b357e49762a8f4b0&st=1610267024346&sv=121'
    $.post(jdUrl('isvObfuscator', body), async (err, resp, data) => {
      try {
        if (err) {
          console.log(`${$.name} API请求失败，请检查网路重试`)
        } else {
          if (safeGet(data)) {
            data = JSON.parse(data);
            $.token2 = data['token']
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve(data);
      }
    })
  })
}

// 获得游戏的Cookie
function getActCk() {
  return new Promise(resolve => {
    $.get(taskUrl("dingzhi/book/develop/activity", `activityId=${ACT_ID}`), (err, resp, data) => {
      try {
        if (err) {
          console.log(`${$.name} API请求失败，请检查网路重试`)
        } else {
          if($.isNode())
            for (let ck of resp['headers']['set-cookie']) {
              cookie = `${cookie}; ${ck.split(";")[0]};`
            }
          else{
            for (let ck of resp['headers']['Set-Cookie'].split(',')) {
              cookie = `${cookie}; ${ck.split(";")[0]};`
            }
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve(data);
      }
    })
  })
}

// 获得游戏信息
function getActInfo() {
  return new Promise(resolve => {
    $.post(taskPostUrl('dz/common/getSimpleActInfoVo', `activityId=${ACT_ID}`), async (err, resp, data) => {
      try {
        if (err) {
          console.log(`${$.name} API请求失败，请检查网路重试`)
        } else {
          if (safeGet(data)) {
            data = JSON.parse(data);
            if (data.result) {
              $.shopId = data.data.shopId
            }
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve(data);
      }
    })
  })
}

// 获得游戏的Token
function getToken() {
  return new Promise(resolve => {
    let body = `userId=${$.shopId}&token=${$.token2}&fromType=APP`
    $.post(taskPostUrl('customer/getMyPing', body), async (err, resp, data) => {
      try {
        if (err) {
          console.log(`${$.name} API请求失败，请检查网路重试`)
        } else {
          if (safeGet(data)) {
            data = JSON.parse(data);
            $.token = data.data.secretPin
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve(data);
      }
    })
  })
}

// 获得用户信息
function getUserInfo() {
  return new Promise(resolve => {
    let body = `pin=${encodeURIComponent($.token)}`
    $.post(taskPostUrl('wxActionCommon/getUserInfo', body), async (err, resp, data) => {
      try {
        if (err) {
          console.log(`${$.name} API请求失败，请检查网路重试`)
        } else {
          if (safeGet(data)) {
            data = JSON.parse(data);
            if (data.data) {
              console.log(`用户【${data.data.nickname}】信息获取成功`)
              $.userId = data.data.id
              $.pinImg = data.data.yunMidImageUrl
              $.nick = data.data.nickname
            }
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve(data);
      }
    })
  })
}

// 获得游戏信息
function getActContent(info = false, shareUuid = '') {
  return new Promise(resolve => {
    let body = `activityId=${ACT_ID}&pin=${encodeURIComponent($.token)}&pinImg=${$.pinImg}&nick=${$.nick}&cjyxPin=&cjhyPin=&shareUuid=${shareUuid}`
    $.post(taskPostUrl('dingzhi/book/develop/activityContent', body), async (err, resp, data) => {
      try {
        if (err) {
          console.log(`${$.name} API请求失败，请检查网路重试`)
        } else {
          if (data && safeGet(data)) {
            data = JSON.parse(data);
            if (data.data) {
              $.userInfo = data.data
              if (!$.userInfo.bookStore) {
                $.exit = true
                console.log(`京东账号${$.index}尚未开启口袋书店，请手动开启`)
                return
              }
              $.actorUuid = $.userInfo.actorUuid
              if(!info) console.log(`您的好友助力码为${$.actorUuid}`)
              $.gold = $.userInfo.bookStore.hasStoreGold
              if (!info) {
                const tasks = data.data.settingVo
                for (let task of tasks) {
                  if (['关注店铺'].includes(task.title)) {
                    if (task.okNum < task.dayMaxNum) {
                      console.log(`去做${task.title}任务`)
                      await doTask(task.settings[0].type, task.settings[0].value)
                    }
                  } else if (['逛会场', '浏览店铺', '浏览商品'].includes(task.title)) {
                    if (task.okNum < task.dayMaxNum) {
                      console.log(`去做${task.title}任务`)
                      for (let set of task.settings.filter(vo => vo.status === 0)) {
                        await doTask(set.type, set.value)
                        await $.wait(500)
                      }
                    }
                  } else if(task.title === '每日签到'){
                    const hour = new Date().getUTCHours() + 8
                    if (8 <= hour && hour < 10 || 12 <= hour && hour < 14 || 18 <= hour && hour < 20) {
                      console.log(`去做${task.title}任务`)
                      for (let set of task.settings.filter(vo => vo.status === 0)) {
                        let res = await doTask(set.type, set.value)
                        if (res.result) break
                        await $.wait(500)
                      }
                    }
                  } else if (ADD_CART && ['加购商品'].includes(task.title)) {
                    if (task.okNum < task.dayMaxNum) {
                      console.log(`去做${task.title}任务`)
                      await doTask(task.settings[0].type, task.settings[0].value)
                    }
                  }
                }
              }
            }
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve(data);
      }
    })
  })
}
function doHelpList(taskType, value) {
  let body = `activityId=${ACT_ID}&actorUuid=${$.actorUuid}&num=0&sortStatus=1`
  return new Promise(resolve => {
    $.post(taskPostUrl('dingzhi/taskact/common/getDayShareRecord', body), async (err, resp, data) => {
      try {
        if (err) {
          console.log(`${$.name} API请求失败，请检查网路重试`)
        } else {
          if (safeGet(data)) {
            data = JSON.parse(data);
            console.log(`今日助力情况${data.data.length}/10`)
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve(data);
      }
    })
  })

}
// 做任务
function doTask(taskType, value) {
  let body = `activityId=${ACT_ID}&pin=${encodeURIComponent($.token)}&actorUuid=${$.actorUuid}&taskType=${taskType}&taskValue=${value}`
  return new Promise(resolve => {
    $.post(taskPostUrl('dingzhi/book/develop/saveTask', body), async (err, resp, data) => {
      try {
        if (err) {
          console.log(`${$.name} API请求失败，请检查网路重试`)
        } else {
          if (safeGet(data)) {
            data = JSON.parse(data);
            if (data.result && data.data) {
              console.log(`任务完成成功，获得${data.data.addScore}积分`)
              $.score += data.data.addScore
            } else {
              console.log(`任务完成失败，错误信息：${data.errorMessage}`)
            }
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve(data);
      }
    })
  })

}

// 抽奖
function draw() {
  let body = `activityId=${ACT_ID}&pin=${encodeURIComponent($.token)}&actorUuid=${$.actorUuid}`
  return new Promise(resolve => {
    $.post(taskPostUrl('dingzhi/book/develop/startDraw', body), async (err, resp, data) => {
      try {
        if (err) {
          console.log(`${$.name} API请求失败，请检查网路重试`)
        } else {
          if (data && safeGet(data)) {
            data = JSON.parse(data);
            if (data.result && data.data) {
              if (data.data.name) {
                console.log(`抽奖成功，获得奖品：${data.data.name}`)
                message += `抽奖成功，获得奖品：${data.data.name}\n`
              } else {
                console.log(`抽奖成功，获得空气`)
                message += `抽奖成功，获得空气`
              }
            }
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve(data);
      }
    })
  })
}

// 获得图书
function getAllBook() {
  let body = `activityId=${ACT_ID}&actorUuid=${$.actorUuid}&pin=${encodeURIComponent($.token)}`
  return new Promise(resolve => {
    $.post(taskPostUrl('dingzhi/book/develop/getAllBook', body), async (err, resp, data) => {
      try {
        if (err) {
          console.log(`${$.name} API请求失败，请检查网路重试`)
        } else {
          if (safeGet(data)) {
            data = JSON.parse(data);
            if (data.result && data.data) {

              const book = data.data.bookConfigList[0]
              let num = Math.trunc(data.data.haveScore / book.buyBookScore)
              console.log(`拥有${data.data.haveScore}积分，可购买${num}本`)
              if (num > 0) {
                await buyBook(book.uuid, num)
              }
            }
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve(data);
      }
    })
  })
}

// 购买图书
function buyBook(bookUuid, num) {
  let body = `activityId=${ACT_ID}&actorUuid=${$.actorUuid}&pin=${encodeURIComponent($.token)}&bookUuid=${bookUuid}&buyNum=${num}`
  return new Promise(resolve => {
    $.post(taskPostUrl('dingzhi/book/develop/buyBook', body), async (err, resp, data) => {
      try {
        if (err) {
          console.log(`${$.name} API请求失败，请检查网路重试`)
        } else {
          if (safeGet(data)) {
            data = JSON.parse(data);
            if (data.result && data.data) {
              console.log(`购买【${data.data.BookIncome.bookName}】成功`)
            }
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve(data);
      }
    })
  })
}

function getMyBook() {
  let body = `activityId=${ACT_ID}&actorUuid=${$.actorUuid}&pin=${encodeURIComponent($.token)}&type1=1&type2=1&type3=1&type=1`
  return new Promise(resolve => {
    $.post(taskPostUrl('dingzhi/book/develop/getMyBook', body), async (err, resp, data) => {
      try {
        if (err) {
          console.log(`${$.name} API请求失败，请检查网路重试`)
        } else {
          if (safeGet(data)) {
            data = JSON.parse(data);
            if (data.result && data.data) {
              for (let book of data.data.myBookList) {
                if (book.isPutOn !== 1 && book.inventory > 0) {
                  console.log(`去上架【${book.bookName}】`)
                  await upBook(book.bookUuid)
                }
              }
            }
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve(data);
      }
    })
  })
}

function upBook(bookUuid) {
  let body = `activityId=${ACT_ID}&actorUuid=${$.actorUuid}&pin=${encodeURIComponent($.token)}&bookUuid=${bookUuid}&isPutOn=1&position=1`
  return new Promise(resolve => {
    $.post(taskPostUrl('dingzhi/book/develop/upBook', body), async (err, resp, data) => {
      try {
        if (err) {
          console.log(`${$.name} API请求失败，请检查网路重试`)
        } else {
          if (safeGet(data)) {
            data = JSON.parse(data);
            if (data.result && data.data) {
              console.log(`上架成功`)
            } else {
              console.log(data)
            }
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve(data);
      }
    })
  })
}

function chargeGold() {
  let body = `activityId=${ACT_ID}&actorUuid=${$.actorUuid}&pin=${encodeURIComponent($.token)}`
  return new Promise(resolve => {
    $.post(taskPostUrl('dingzhi/book/develop/chargeGold', body), async (err, resp, data) => {
      try {
        if (err) {
          console.log(`${$.name} API请求失败，请检查网路重试`)
        } else {
          if (safeGet(data)) {
            data = JSON.parse(data);
            if (data.result && data.data) {
              console.log(`金币收获成功，获得${data.data.chargeGold}`)
            } else {
              console.log(data.errorMessage)
            }
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve(data);
      }
    })
  })
}

function showMsg() {
  return new Promise(resolve => {
    message += `本次运行获得积分${$.score}`;
    $.msg($.name, '', `京东账号${$.index}${$.nickName}\n${message}`);
    resolve()
  })
}

function jdUrl(functionId, body) {
  return {
    url: `https://api.m.jd.com/client.action?functionId=${functionId}`,
    body: body,
    headers: {
      'Host': 'api.m.jd.com',
      'accept': '*/*',
      'user-agent': 'JD4iPhone/167490 (iPhone; iOS 14.2; Scale/3.00)',
      'accept-language': 'zh-Hans-JP;q=1, en-JP;q=0.9, zh-Hant-TW;q=0.8, ja-JP;q=0.7, en-US;q=0.6',
      'content-type': 'application/x-www-form-urlencoded',
      'Cookie': cookie
    }
  }
}

function taskUrl(function_id, body) {
  return {
    url: `https://lzdz-isv.isvjcloud.com/${function_id}?${body}`,
    headers: {
      'Host': 'lzdz-isv.isvjcloud.com',
      'Accept': 'application/x.jd-school-island.v1+json',
      'Source': '02',
      'Accept-Language': 'zh-cn',
      'Content-Type': 'application/json;charset=utf-8',
      'Origin': 'https://lzdz-isv.isvjcloud.com',
      'User-Agent': 'JD4iPhone/167490 (iPhone; iOS 14.2; Scale/3.00)',
      'Referer': `https://lzdz-isv.isvjcloud.com/dingzhi/book/develop/activity?activityId=${ACT_ID}`,
      'Cookie': `${cookie} IsvToken=${$.isvToken};`
    }
  }
}

function taskPostUrl(function_id, body) {
  return {
    url: `https://lzdz-isv.isvjcloud.com/${function_id}`,
    body: body,
    headers: {
      'Host': 'lzdz-isv.isvjcloud.com',
      'Accept': 'application/json',
      'Accept-Language': 'zh-cn',
      'Content-Type': 'application/x-www-form-urlencoded',
      'Origin': 'https://lzdz-isv.isvjcloud.com',
      'User-Agent': 'JD4iPhone/167490 (iPhone; iOS 14.2; Scale/3.00)',
      'Referer': `https://lzdz-isv.isvjcloud.com/dingzhi/book/develop/activity?activityId=${ACT_ID}`,
      'Cookie': `${cookie} isvToken=${$.isvToken};`
    }
  }
}

function TotalBean() {
  return new Promise(async resolve => {
    const options = {
      "url": `https://wq.jd.com/user/info/QueryJDUserInfo?sceneval=2`,
      "headers": {
        "Accept": "application/json,text/plain, */*",
        "Content-Type": "application/x-www-form-urlencoded",
        "Accept-Encoding": "gzip, deflate, br",
        "Accept-Language": "zh-cn",
        "Connection": "keep-alive",
        "Cookie": cookie,
        "Referer": "https://wqs.jd.com/my/jingdou/my.shtml?sceneval=2",
        "User-Agent": $.isNode() ? (process.env.JD_USER_AGENT ? process.env.JD_USER_AGENT : (require('./USER_AGENTS').USER_AGENT)) : ($.getdata('JDUA') ? $.getdata('JDUA') : "jdapp;iPhone;9.2.2;14.2;%E4%BA%AC%E4%B8%9C/9.2.2 CFNetwork/1206 Darwin/20.1.0")
      }
    }
    $.post(options, (err, resp, data) => {
      try {
        if (err) {
          console.log(`${JSON.stringify(err)}`)
          console.log(`${$.name} API请求失败，请检查网路重试`)
        } else {
          if (data) {
            data = JSON.parse(data);
            if (data['retcode'] === 13) {
              $.isLogin = false; //cookie过期
              return
            }
            $.nickName = data['base'].nickname;
          } else {
            console.log(`京东服务器返回空数据`)
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve();
      }
    })
  })
}

//格式化助力码
function shareCodesFormat() {
  return new Promise(async resolve => {
    // console.log(`第${$.index}个京东账号的助力码:::${$.shareCodesArr[$.index - 1]}`)
    $.newShareCodes = [];
    if ($.shareCodesArr[$.index - 1]) {
      $.newShareCodes = $.shareCodesArr[$.index - 1].split('@');
    } else {
      console.log(`由于您第${$.index}个京东账号未提供shareCode,将采纳本脚本自带的助力码\n`)
      const tempIndex = $.index > inviteCodes.length ? (inviteCodes.length - 1) : ($.index - 1);
      $.newShareCodes = inviteCodes[tempIndex].split('@');
    }
    const readShareCodeRes = null //await readShareCode();
    if (readShareCodeRes && readShareCodeRes.code === 200) {
      $.newShareCodes = [...new Set([...$.newShareCodes, ...(readShareCodeRes.data || [])])];
    }
    console.log(`第${$.index}个京东账号将要助力的好友${JSON.stringify($.newShareCodes)}`)
    resolve();
  })
}
function requireConfig() {
  return new Promise(resolve => {
    console.log(`开始获取${$.name}配置文件\n`);
    //Node.js用户请在jdCookie.js处填写京东ck;
    let shareCodes = []
    console.log(`共${cookiesArr.length}个京东账号\n`);
    $.shareCodesArr = [];
    if ($.isNode()) {
      //自定义助力码
      if (process.env.BOOKSHOP_SHARECODES) {
        if (process.env.BOOKSHOP_SHARECODES.indexOf('\n') > -1) {
          shareCodes = process.env.BOOKSHOP_SHARECODES.split('\n');
        } else {
          shareCodes = process.env.BOOKSHOP_SHARECODES.split('&');
        }
      }
      Object.keys(shareCodes).forEach((item) => {
        if (shareCodes[item]) {
          $.shareCodesArr.push(shareCodes[item])
        }
      })
    }
    console.log(`您提供了${$.shareCodesArr.length}个账号的${$.name}助力码\n`);
    resolve()
  })
}

function safeGet(data) {
  try {
    if (typeof JSON.parse(data) == "object") {
      return true;
    }
  } catch (e) {
    console.log(e);
    console.log(`京东服务器访问数据为空，请检查自身设备网络情况`);
    return false;
  }
}

function jsonParse(str) {
  if (typeof str == "string") {
    try {
      return JSON.parse(str);
    } catch (e) {
      console.log(e);
      $.msg($.name, '', '不要在BoxJS手动复制粘贴修改cookie')
      return [];
    }
  }
}
// prettier-ignore
function Env(t,e){"undefined"!=typeof process&&JSON.stringify(process.env).indexOf("GITHUB")>-1&&process.exit(0);class s{constructor(t){this.env=t}send(t,e="GET"){t="string"==typeof t?{url:t}:t;let s=this.get;return"POST"===e&&(s=this.post),new Promise((e,i)=>{s.call(this,t,(t,s,r)=>{t?i(t):e(s)})})}get(t){return this.send.call(this.env,t)}post(t){return this.send.call(this.env,t,"POST")}}return new class{constructor(t,e){this.name=t,this.http=new s(this),this.data=null,this.dataFile="box.dat",this.logs=[],this.isMute=!1,this.isNeedRewrite=!1,this.logSeparator="\n",this.startTime=(new Date).getTime(),Object.assign(this,e),this.log("",`🔔${this.name}, 开始!`)}isNode(){return"undefined"!=typeof module&&!!module.exports}isQuanX(){return"undefined"!=typeof $task}isSurge(){return"undefined"!=typeof $httpClient&&"undefined"==typeof $loon}isLoon(){return"undefined"!=typeof $loon}toObj(t,e=null){try{return JSON.parse(t)}catch{return e}}toStr(t,e=null){try{return JSON.stringify(t)}catch{return e}}getjson(t,e){let s=e;const i=this.getdata(t);if(i)try{s=JSON.parse(this.getdata(t))}catch{}return s}setjson(t,e){try{return this.setdata(JSON.stringify(t),e)}catch{return!1}}getScript(t){return new Promise(e=>{this.get({url:t},(t,s,i)=>e(i))})}runScript(t,e){return new Promise(s=>{let i=this.getdata("@chavy_boxjs_userCfgs.httpapi");i=i?i.replace(/\n/g,"").trim():i;let r=this.getdata("@chavy_boxjs_userCfgs.httpapi_timeout");r=r?1*r:20,r=e&&e.timeout?e.timeout:r;const[o,h]=i.split("@"),n={url:`http://${h}/v1/scripting/evaluate`,body:{script_text:t,mock_type:"cron",timeout:r},headers:{"X-Key":o,Accept:"*/*"}};this.post(n,(t,e,i)=>s(i))}).catch(t=>this.logErr(t))}loaddata(){if(!this.isNode())return{};{this.fs=this.fs?this.fs:require("fs"),this.path=this.path?this.path:require("path");const t=this.path.resolve(this.dataFile),e=this.path.resolve(process.cwd(),this.dataFile),s=this.fs.existsSync(t),i=!s&&this.fs.existsSync(e);if(!s&&!i)return{};{const i=s?t:e;try{return JSON.parse(this.fs.readFileSync(i))}catch(t){return{}}}}}writedata(){if(this.isNode()){this.fs=this.fs?this.fs:require("fs"),this.path=this.path?this.path:require("path");const t=this.path.resolve(this.dataFile),e=this.path.resolve(process.cwd(),this.dataFile),s=this.fs.existsSync(t),i=!s&&this.fs.existsSync(e),r=JSON.stringify(this.data);s?this.fs.writeFileSync(t,r):i?this.fs.writeFileSync(e,r):this.fs.writeFileSync(t,r)}}lodash_get(t,e,s){const i=e.replace(/\[(\d+)\]/g,".$1").split(".");let r=t;for(const t of i)if(r=Object(r)[t],void 0===r)return s;return r}lodash_set(t,e,s){return Object(t)!==t?t:(Array.isArray(e)||(e=e.toString().match(/[^.[\]]+/g)||[]),e.slice(0,-1).reduce((t,s,i)=>Object(t[s])===t[s]?t[s]:t[s]=Math.abs(e[i+1])>>0==+e[i+1]?[]:{},t)[e[e.length-1]]=s,t)}getdata(t){let e=this.getval(t);if(/^@/.test(t)){const[,s,i]=/^@(.*?)\.(.*?)$/.exec(t),r=s?this.getval(s):"";if(r)try{const t=JSON.parse(r);e=t?this.lodash_get(t,i,""):e}catch(t){e=""}}return e}setdata(t,e){let s=!1;if(/^@/.test(e)){const[,i,r]=/^@(.*?)\.(.*?)$/.exec(e),o=this.getval(i),h=i?"null"===o?null:o||"{}":"{}";try{const e=JSON.parse(h);this.lodash_set(e,r,t),s=this.setval(JSON.stringify(e),i)}catch(e){const o={};this.lodash_set(o,r,t),s=this.setval(JSON.stringify(o),i)}}else s=this.setval(t,e);return s}getval(t){return this.isSurge()||this.isLoon()?$persistentStore.read(t):this.isQuanX()?$prefs.valueForKey(t):this.isNode()?(this.data=this.loaddata(),this.data[t]):this.data&&this.data[t]||null}setval(t,e){return this.isSurge()||this.isLoon()?$persistentStore.write(t,e):this.isQuanX()?$prefs.setValueForKey(t,e):this.isNode()?(this.data=this.loaddata(),this.data[e]=t,this.writedata(),!0):this.data&&this.data[e]||null}initGotEnv(t){this.got=this.got?this.got:require("got"),this.cktough=this.cktough?this.cktough:require("tough-cookie"),this.ckjar=this.ckjar?this.ckjar:new this.cktough.CookieJar,t&&(t.headers=t.headers?t.headers:{},void 0===t.headers.Cookie&&void 0===t.cookieJar&&(t.cookieJar=this.ckjar))}get(t,e=(()=>{})){t.headers&&(delete t.headers["Content-Type"],delete t.headers["Content-Length"]),this.isSurge()||this.isLoon()?(this.isSurge()&&this.isNeedRewrite&&(t.headers=t.headers||{},Object.assign(t.headers,{"X-Surge-Skip-Scripting":!1})),$httpClient.get(t,(t,s,i)=>{!t&&s&&(s.body=i,s.statusCode=s.status),e(t,s,i)})):this.isQuanX()?(this.isNeedRewrite&&(t.opts=t.opts||{},Object.assign(t.opts,{hints:!1})),$task.fetch(t).then(t=>{const{statusCode:s,statusCode:i,headers:r,body:o}=t;e(null,{status:s,statusCode:i,headers:r,body:o},o)},t=>e(t))):this.isNode()&&(this.initGotEnv(t),this.got(t).on("redirect",(t,e)=>{try{if(t.headers["set-cookie"]){const s=t.headers["set-cookie"].map(this.cktough.Cookie.parse).toString();s&&this.ckjar.setCookieSync(s,null),e.cookieJar=this.ckjar}}catch(t){this.logErr(t)}}).then(t=>{const{statusCode:s,statusCode:i,headers:r,body:o}=t;e(null,{status:s,statusCode:i,headers:r,body:o},o)},t=>{const{message:s,response:i}=t;e(s,i,i&&i.body)}))}post(t,e=(()=>{})){if(t.body&&t.headers&&!t.headers["Content-Type"]&&(t.headers["Content-Type"]="application/x-www-form-urlencoded"),t.headers&&delete t.headers["Content-Length"],this.isSurge()||this.isLoon())this.isSurge()&&this.isNeedRewrite&&(t.headers=t.headers||{},Object.assign(t.headers,{"X-Surge-Skip-Scripting":!1})),$httpClient.post(t,(t,s,i)=>{!t&&s&&(s.body=i,s.statusCode=s.status),e(t,s,i)});else if(this.isQuanX())t.method="POST",this.isNeedRewrite&&(t.opts=t.opts||{},Object.assign(t.opts,{hints:!1})),$task.fetch(t).then(t=>{const{statusCode:s,statusCode:i,headers:r,body:o}=t;e(null,{status:s,statusCode:i,headers:r,body:o},o)},t=>e(t));else if(this.isNode()){this.initGotEnv(t);const{url:s,...i}=t;this.got.post(s,i).then(t=>{const{statusCode:s,statusCode:i,headers:r,body:o}=t;e(null,{status:s,statusCode:i,headers:r,body:o},o)},t=>{const{message:s,response:i}=t;e(s,i,i&&i.body)})}}time(t,e=null){const s=e?new Date(e):new Date;let i={"M+":s.getMonth()+1,"d+":s.getDate(),"H+":s.getHours(),"m+":s.getMinutes(),"s+":s.getSeconds(),"q+":Math.floor((s.getMonth()+3)/3),S:s.getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(s.getFullYear()+"").substr(4-RegExp.$1.length)));for(let e in i)new RegExp("("+e+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?i[e]:("00"+i[e]).substr((""+i[e]).length)));return t}msg(e=t,s="",i="",r){const o=t=>{if(!t)return t;if("string"==typeof t)return this.isLoon()?t:this.isQuanX()?{"open-url":t}:this.isSurge()?{url:t}:void 0;if("object"==typeof t){if(this.isLoon()){let e=t.openUrl||t.url||t["open-url"],s=t.mediaUrl||t["media-url"];return{openUrl:e,mediaUrl:s}}if(this.isQuanX()){let e=t["open-url"]||t.url||t.openUrl,s=t["media-url"]||t.mediaUrl;return{"open-url":e,"media-url":s}}if(this.isSurge()){let e=t.url||t.openUrl||t["open-url"];return{url:e}}}};if(this.isMute||(this.isSurge()||this.isLoon()?$notification.post(e,s,i,o(r)):this.isQuanX()&&$notify(e,s,i,o(r))),!this.isMuteLog){let t=["","==============📣系统通知📣=============="];t.push(e),s&&t.push(s),i&&t.push(i),console.log(t.join("\n")),this.logs=this.logs.concat(t)}}log(...t){t.length>0&&(this.logs=[...this.logs,...t]),console.log(t.join(this.logSeparator))}logErr(t,e){const s=!this.isSurge()&&!this.isQuanX()&&!this.isLoon();s?this.log("",`❗️${this.name}, 错误!`,t.stack):this.log("",`❗️${this.name}, 错误!`,t)}wait(t){return new Promise(e=>setTimeout(e,t))}done(t={}){const e=(new Date).getTime(),s=(e-this.startTime)/1e3;this.log("",`🔔${this.name}, 结束! 🕛 ${s} 秒`),this.log(),(this.isSurge()||this.isQuanX()||this.isLoon())&&$done(t)}}(t,e)}
